---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: OWIN OAuth 2.0 Autorisierungsserver | Microsoft Docs
author: hongyes
description: In diesem Tutorial erfahren Sie, wie Sie einen OAuth 2.0 Authorization Server mit OWIN OAuth-Middleware implementieren. Dies ist ein erweitertes Tutorial, das nur outlin...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540399"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="611b9-104">OWIN-OAuth 2.0-Autorisierungsserver</span><span class="sxs-lookup"><span data-stu-id="611b9-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="611b9-105">von [Hongye Sun](https://github.com/hongyes) und [Praburaj Thiagarajan](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="611b9-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="611b9-106">In diesem Tutorial erfahren Sie, wie Sie einen OAuth 2.0 Authorization Server mit OWIN OAuth-Middleware implementieren.</span><span class="sxs-lookup"><span data-stu-id="611b9-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="611b9-107">Dies ist ein erweitertes Tutorial, das nur die Schritte zum Erstellen eines OWIN OAuth 2.0 Autorisierungsservers beschreibt.</span><span class="sxs-lookup"><span data-stu-id="611b9-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="611b9-108">Dies ist kein Schritt-für-Schritt-Tutorial.</span><span class="sxs-lookup"><span data-stu-id="611b9-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="611b9-109">[Laden Sie den Beispielcode herunter.](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip)</span><span class="sxs-lookup"><span data-stu-id="611b9-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="611b9-110">Diese Gliederung sollte nicht zum Erstellen einer sicheren Produktions-App verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="611b9-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="611b9-111">Dieses Tutorial soll nur eine Übersicht darüber enthalten, wie ein OAuth 2.0 Authorization Server mit OWIN OAuth Middleware implementiert wird.</span><span class="sxs-lookup"><span data-stu-id="611b9-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="611b9-112">Softwareversionen</span><span class="sxs-lookup"><span data-stu-id="611b9-112">Software versions</span></span>
>
> | <span data-ttu-id="611b9-113">**Im Tutorial gezeigt**</span><span class="sxs-lookup"><span data-stu-id="611b9-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="611b9-114">**Funktioniert auch mit**</span><span class="sxs-lookup"><span data-stu-id="611b9-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="611b9-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="611b9-115">Windows 8.1</span></span> | <span data-ttu-id="611b9-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="611b9-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="611b9-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="611b9-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="611b9-118">[Visual Studio 2013 Express für Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="611b9-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="611b9-119">Visual Studio 2012 mit dem neuesten Update sollte funktionieren, aber das Tutorial wurde nicht damit getestet, und einige Menüauswahlen und Dialogfelder unterscheiden sich.</span><span class="sxs-lookup"><span data-stu-id="611b9-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="611b9-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="611b9-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="611b9-121">Fragen und Kommentare</span><span class="sxs-lookup"><span data-stu-id="611b9-121">Questions and Comments</span></span>
>
> <span data-ttu-id="611b9-122">Wenn Sie Fragen haben, die nicht direkt mit dem Tutorial zusammenhängen, können Sie diese bei [Katana Project auf GitHub](https://github.com/aspnet/AspNetKatana/)veröffentlichen.</span><span class="sxs-lookup"><span data-stu-id="611b9-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="611b9-123">Fragen und Kommentare zum Tutorial selbst finden Sie im Kommentarbereich am unteren Rand der Seite.</span><span class="sxs-lookup"><span data-stu-id="611b9-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="611b9-124">Das [OAuth 2.0-Framework](http://tools.ietf.org/html/rfc6749) ermöglicht es einer Drittanbieter-App, eingeschränkten Zugriff auf einen HTTP-Dienst zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="611b9-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="611b9-125">Anstatt die Anmeldeinformationen des Ressourcenbesitzers für den Zugriff auf eine geschützte Ressource zu verwenden, ruft der Client ein Zugriffstoken ab (eine Zeichenfolge, die einen bestimmten Bereich, eine bestimmte Lebensdauer und andere Zugriffsattribute angibt).</span><span class="sxs-lookup"><span data-stu-id="611b9-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="611b9-126">Zugriffstoken werden von einem Autorisierungsserver mit Genehmigung des Ressourcenbesitzers an Clients von Drittanbietern ausgestellt.</span><span class="sxs-lookup"><span data-stu-id="611b9-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="611b9-127">Dieses Tutorial behandelt:</span><span class="sxs-lookup"><span data-stu-id="611b9-127">This tutorial will cover:</span></span>

- <span data-ttu-id="611b9-128">So erstellen Sie einen Autorisierungsserver, um vier Autorisierungserteilungstypen und Aktualisierungstoken zu unterstützen:</span><span class="sxs-lookup"><span data-stu-id="611b9-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="611b9-129">Autorisierungscodeerteilung</span><span class="sxs-lookup"><span data-stu-id="611b9-129">Authorization code grant</span></span>
    - <span data-ttu-id="611b9-130">Implizite Zuscheine</span><span class="sxs-lookup"><span data-stu-id="611b9-130">Implicit Grant</span></span>
    - <span data-ttu-id="611b9-131">Resource Owner Password Credentials Grant</span><span class="sxs-lookup"><span data-stu-id="611b9-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="611b9-132">Clientcredentials Grant</span><span class="sxs-lookup"><span data-stu-id="611b9-132">Client Credentials Grant</span></span>
- <span data-ttu-id="611b9-133">Erstellen eines Ressourcenservers, der durch ein Zugriffstoken geschützt ist.</span><span class="sxs-lookup"><span data-stu-id="611b9-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="611b9-134">Erstellen von OAuth 2.0-Clients.</span><span class="sxs-lookup"><span data-stu-id="611b9-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="611b9-135">Voraussetzungen</span><span class="sxs-lookup"><span data-stu-id="611b9-135">Prerequisites</span></span>

- <span data-ttu-id="611b9-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) oder das kostenlose [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), wie in **Softwareversionen** oben auf der Seite angegeben.</span><span class="sxs-lookup"><span data-stu-id="611b9-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="611b9-137">Vertrautheit mit OWIN.</span><span class="sxs-lookup"><span data-stu-id="611b9-137">Familiarity with OWIN.</span></span> <span data-ttu-id="611b9-138">Weitere Informationen finden Sie unter [Erste Schritte mit dem Katana-Projekt](https://msdn.microsoft.com/magazine/dn451439.aspx) und [Neuerungen in OWIN und Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="611b9-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="611b9-139">Vertrautheit mit [OAuth-Terminologie,](http://tools.ietf.org/html/rfc6749) einschließlich [Rollen](http://tools.ietf.org/html/rfc6749#section-1.1), [Protokollfluss](http://tools.ietf.org/html/rfc6749#section-1.2)und [Autorisierungserteilung](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="611b9-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="611b9-140">Die Einführung von [OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) bietet eine gute Einführung.</span><span class="sxs-lookup"><span data-stu-id="611b9-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="611b9-141">Erstellen eines Autorisierungsservers</span><span class="sxs-lookup"><span data-stu-id="611b9-141">Create an Authorization Server</span></span>

<span data-ttu-id="611b9-142">In diesem Tutorial wird grob skizziert, wie [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) und ASP.NET MVC verwendet werden, um einen Autorisierungsserver zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="611b9-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="611b9-143">Wir hoffen, bald einen Download für das fertige Beispiel zur Verfügung zu stellen, da dieses Tutorial nicht jeden Schritt enthält.</span><span class="sxs-lookup"><span data-stu-id="611b9-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="611b9-144">Erstellen Sie zunächst eine leere Web-App mit dem Namen *AuthorizationServer,* und installieren Sie die folgenden Pakete:</span><span class="sxs-lookup"><span data-stu-id="611b9-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="611b9-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="611b9-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="611b9-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="611b9-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="611b9-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="611b9-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="611b9-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="611b9-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="611b9-149">Microsoft.Owin.Security.Google (oder jedes andere Social-Login-Paket wie Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="611b9-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="611b9-150">Fügen Sie eine [OWIN-Startklasse](owin-startup-class-detection.md) unter dem Projektstammordner mit dem Namen *Startup*hinzu.</span><span class="sxs-lookup"><span data-stu-id="611b9-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="611b9-151">Erstellen Sie einen *\_App-Startordner.*</span><span class="sxs-lookup"><span data-stu-id="611b9-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="611b9-152">Wählen Sie den Ordner *App\_Start* aus, und verwenden Sie Shift+Alt+A, um die heruntergeladene Version der Datei *AuthorizationServer-App\_Start.Auth.cs* hinzuzufügen.</span><span class="sxs-lookup"><span data-stu-id="611b9-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="611b9-153">Der obige Code ermöglicht Anwendungs-/externe Anmeldecookies und Die Google-Authentifizierung, die vom Autorisierungsserver selbst zur Verwaltung von Konten verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="611b9-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="611b9-154">Die `UseOAuthAuthorizationServer` Erweiterungsmethode besteht darin, den Autorisierungsserver einzurichten.</span><span class="sxs-lookup"><span data-stu-id="611b9-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="611b9-155">Die Einrichtungsoptionen sind:</span><span class="sxs-lookup"><span data-stu-id="611b9-155">The setup options are:</span></span>

- <span data-ttu-id="611b9-156">`AuthorizeEndpointPath`: Der Anforderungspfad, in dem Clientanwendungen den Benutzer-Agent umleiten, um die Zustimmung der Benutzer zum Ausstellen eines Tokens oder Codes einzuholen.</span><span class="sxs-lookup"><span data-stu-id="611b9-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="611b9-157">Es muss mit einem führenden Schrägstrich`/Authorize`beginnen, zum Beispiel " ".</span><span class="sxs-lookup"><span data-stu-id="611b9-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="611b9-158">`TokenEndpointPath`: Die Clientanwendungen des Anforderungspfads kommunizieren direkt, um das Zugriffstoken abzurufen.</span><span class="sxs-lookup"><span data-stu-id="611b9-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="611b9-159">Es muss mit einem führenden Schrägstrich beginnen, wie "/Token".</span><span class="sxs-lookup"><span data-stu-id="611b9-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="611b9-160">Wenn dem Client ein [geheimer Client\_](http://tools.ietf.org/html/rfc6749#appendix-A.2)ausgegeben wird, muss er diesem Endpunkt zur Verfügung gestellt werden.</span><span class="sxs-lookup"><span data-stu-id="611b9-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="611b9-161">`ApplicationCanDisplayErrors`: Legen `true` Sie fest, ob die Webanwendung eine benutzerdefinierte `/Authorize` Fehlerseite für die Clientvalidierungsfehler auf dem Endpunkt generieren möchte.</span><span class="sxs-lookup"><span data-stu-id="611b9-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="611b9-162">Dies ist nur in Fällen erforderlich, in denen der Browser nicht `client_id` zurück `redirect_uri` an die Clientanwendung umgeleitet wird, z. B. wenn die oder falsch sind.</span><span class="sxs-lookup"><span data-stu-id="611b9-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="611b9-163">Der `/Authorize` Endpunkt sollte erwarten, dass "oauth. Fehler", "oauth. ErrorDescription" und "oauth. ErrorUri"-Eigenschaften werden der OWIN-Umgebung hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="611b9-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="611b9-164">Wenn nicht wahr, gibt der Autorisierungsserver eine Standardfehlerseite mit den Fehlerdetails zurück.</span><span class="sxs-lookup"><span data-stu-id="611b9-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="611b9-165">`AllowInsecureHttp`: True, um Autorisierungs- und Tokenanforderungen für HTTP-URI-Adressen zu ermöglichen und eingehenden `redirect_uri` Autorisierungsanforderungsparametern zu erlauben, ÜBER HTTP-URI-Adressen zu verfügen.</span><span class="sxs-lookup"><span data-stu-id="611b9-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="611b9-166">Sicherheit - Dies ist nur für die Entwicklung.</span><span class="sxs-lookup"><span data-stu-id="611b9-166">Security - This is for development only.</span></span>
- <span data-ttu-id="611b9-167">`Provider`: Das Objekt, das von der Anwendung bereitgestellt wird, um Ereignisse zu verarbeiten, die von der Authorization Server-Middleware ausgelöst werden.</span><span class="sxs-lookup"><span data-stu-id="611b9-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="611b9-168">Die Anwendung kann die Schnittstelle vollständig implementieren oder `OAuthAuthorizationServerProvider` eine Instanz von erstellen und Delegaten zuweisen, die für die OAuth-Flows erforderlich sind, die dieser Server unterstützt.</span><span class="sxs-lookup"><span data-stu-id="611b9-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="611b9-169">`AuthorizationCodeProvider`: Erstellt einen einmaligen Autorisierungscode, um zur Clientanwendung zurückzukehren.</span><span class="sxs-lookup"><span data-stu-id="611b9-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="611b9-170">Damit der OAuth-Server sicher **MUST** ist, MUSS `AuthorizationCodeProvider` die Anwendung eine `OnCreate/OnCreateAsync` Instanz bereitstellen, für die `OnReceive/OnReceiveAsync`das vom Ereignis erzeugte Token nur für einen Aufruf von als gültig gilt.</span><span class="sxs-lookup"><span data-stu-id="611b9-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="611b9-171">`RefreshTokenProvider`: Erstellt ein Aktualisierungstoken, das bei Bedarf zum Erstellen eines neuen Zugriffstokens verwendet werden kann.</span><span class="sxs-lookup"><span data-stu-id="611b9-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="611b9-172">Wenn nicht angegeben, gibt der Autorisierungsserver `/Token` keine Aktualisierungstoken vom Endpunkt zurück.</span><span class="sxs-lookup"><span data-stu-id="611b9-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="611b9-173">Kontoverwaltung</span><span class="sxs-lookup"><span data-stu-id="611b9-173">Account Management</span></span>

<span data-ttu-id="611b9-174">OAuth ist es egal, wo oder wie Sie Ihre Benutzerkontoinformationen verwalten.</span><span class="sxs-lookup"><span data-stu-id="611b9-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="611b9-175">Es ist [ASP.NET Identität,](../../../identity/index.md) die dafür verantwortlich ist.</span><span class="sxs-lookup"><span data-stu-id="611b9-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="611b9-176">In diesem Tutorial vereinfachen wir den Kontoverwaltungscode und stellen einfach sicher, dass sich der Benutzer mit OWIN-Cookie-Middleware anmelden kann.</span><span class="sxs-lookup"><span data-stu-id="611b9-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="611b9-177">Hier ist der vereinfachte `AccountController`Beispielcode für:</span><span class="sxs-lookup"><span data-stu-id="611b9-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="611b9-178">`ValidateClientRedirectUri`wird verwendet, um den Client mit seiner registrierten Umleitungs-URL zu validieren.</span><span class="sxs-lookup"><span data-stu-id="611b9-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="611b9-179">`ValidateClientAuthentication`überprüft den Grundlegendenschemaheader und Formulartext, um die Anmeldeinformationen des Clients abzufragen.</span><span class="sxs-lookup"><span data-stu-id="611b9-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="611b9-180">Die Anmeldeseite wird unten angezeigt:</span><span class="sxs-lookup"><span data-stu-id="611b9-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="611b9-181">Überprüfen Sie jetzt den Abschnitt OAuth 2 [Authorization Code Grant der](http://tools.ietf.org/html/rfc6749#section-4.1) IETF.</span><span class="sxs-lookup"><span data-stu-id="611b9-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="611b9-182">**Anbieter** (in der folgenden Tabelle) ist [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Anbieter, der vom `OAuthAuthorizationServerProvider`Typ ist, der alle OAuth-Serverereignisse enthält.</span><span class="sxs-lookup"><span data-stu-id="611b9-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="611b9-183">Flow-Schritte aus dem Abschnitt Autorisierungscodeerteilung</span><span class="sxs-lookup"><span data-stu-id="611b9-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="611b9-184">Der Beispieldownload führt die folgenden Schritte aus mit:</span><span class="sxs-lookup"><span data-stu-id="611b9-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="611b9-185">(A) Der Client initiiert den Flow, indem er den Benutzer-Agent des Ressourcenbesitzers an den Autorisierungsendpunkt weiterleitet.</span><span class="sxs-lookup"><span data-stu-id="611b9-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="611b9-186">Der Client enthält seinen Clientbezeichner, den angeforderten Bereich, den lokalen Status und einen Umleitungs-URI, an den der Autorisierungsserver den Benutzer-Agent zurücksendet, sobald der Zugriff gewährt (oder verweigert wird).</span><span class="sxs-lookup"><span data-stu-id="611b9-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="611b9-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="611b9-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="611b9-188">(B) Der Autorisierungsserver authentifiziert den Ressourcenbesitzer (über den Benutzer-Agent) und stellt fest, ob der Ressourcenbesitzer die Zugriffsanforderung des Clients gewährt oder ablehnt.</span><span class="sxs-lookup"><span data-stu-id="611b9-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="611b9-189">**Wenn der&gt; Benutzer Zugriff gewährt &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="611b9-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="611b9-190">(C) Unter der Annahme, dass der Ressourcenbesitzer Zugriff gewährt, leitet der Autorisierungsserver den Benutzer-Agent mithilfe des zuvor angegebenen Umleitungs-URI (in der Anforderung oder während der Clientregistrierung) an den Client zurück.</span><span class="sxs-lookup"><span data-stu-id="611b9-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="611b9-191">...</span><span class="sxs-lookup"><span data-stu-id="611b9-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="611b9-192">(D) Der Client fordert ein Zugriffstoken vom Tokenendpunkt des Autorisierungsservers an, indem er den im vorherigen Schritt empfangenen Autorisierungscode einschließt.</span><span class="sxs-lookup"><span data-stu-id="611b9-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="611b9-193">Bei der Anforderung authentifiziert sich der Client beim Autorisierungsserver.</span><span class="sxs-lookup"><span data-stu-id="611b9-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="611b9-194">Der Client enthält den Umleitungs-URI, der zum Abrufen des Autorisierungscodes zur Überprüfung verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="611b9-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="611b9-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="611b9-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="611b9-196">Eine Beispielimplementierung `AuthorizationCodeProvider.CreateAsync` `ReceiveAsync` für und zur Kontrolle der Erstellung und Validierung von Autorisierungscode wird unten gezeigt.</span><span class="sxs-lookup"><span data-stu-id="611b9-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="611b9-197">Der obige Code verwendet ein in-Memory-Wörterbuch gleichzeitiges Wörterbuch, um den Code und das Identitätsticket zu speichern und die Identität nach dem Empfang des Codes wiederherzustellen.</span><span class="sxs-lookup"><span data-stu-id="611b9-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="611b9-198">In einer echten Anwendung würde sie durch einen persistenten Datenspeicher ersetzt.</span><span class="sxs-lookup"><span data-stu-id="611b9-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="611b9-199">Der Autorisierungsendpunkt ist für den Ressourcenbesitzer, der dem Client Zugriff gewährt.</span><span class="sxs-lookup"><span data-stu-id="611b9-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="611b9-200">In der Regel benötigt es eine Benutzeroberfläche, damit der Benutzer auf eine Schaltfläche klicken und die Erteilung bestätigen kann.</span><span class="sxs-lookup"><span data-stu-id="611b9-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="611b9-201">OWIN OAuth Middleware ermöglicht es Anwendungscode, den Autorisierungsendpunkt zu verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="611b9-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="611b9-202">In unserer Beispiel-App verwenden wir `OAuthController` einen MVC-Controller, der aufgerufen wird, um ihn zu behandeln.</span><span class="sxs-lookup"><span data-stu-id="611b9-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="611b9-203">Hier ist die Beispielimplementierung:</span><span class="sxs-lookup"><span data-stu-id="611b9-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="611b9-204">Die `Authorize` Aktion überprüft zunächst, ob sich der Benutzer beim Autorisierungsserver angemeldet hat.</span><span class="sxs-lookup"><span data-stu-id="611b9-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="611b9-205">Ist dies nicht der Fall, fordert die Authentifizierungsmiddleware den Aufrufer auf, sich mit dem Cookie "Anwendung" zu authentifizieren, und leitet zur Anmeldeseite um.</span><span class="sxs-lookup"><span data-stu-id="611b9-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="611b9-206">(Siehe hervorgehobener Code oben.) Wenn sich der Benutzer angemeldet hat, wird die Ansicht Autorisieren wie unten gezeigt gerendert:</span><span class="sxs-lookup"><span data-stu-id="611b9-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="611b9-207">Wenn die Schaltfläche **"Grant"** ausgewählt ist, erstellt die `Authorize` Aktion eine neue "Träger"-Identität und melden sich damit an.</span><span class="sxs-lookup"><span data-stu-id="611b9-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="611b9-208">Es löst den Autorisierungsserver aus, um ein Inhabertoken zu generieren und es mit JSON-Nutzlast an den Client zurückzusenden.</span><span class="sxs-lookup"><span data-stu-id="611b9-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="611b9-209">Implizite Zuscheine</span><span class="sxs-lookup"><span data-stu-id="611b9-209">Implicit Grant</span></span>

<span data-ttu-id="611b9-210">Siehe jetzt den Abschnitt OAuth 2 [Implicit Grant der](http://tools.ietf.org/html/rfc6749#section-4.2) IETF.</span><span class="sxs-lookup"><span data-stu-id="611b9-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="611b9-211">Der in Abbildung 4 dargestellte [implizite Grant-Flow](http://tools.ietf.org/html/rfc6749#section-4.2) ist der Flow und die Zuordnung, der die OWIN OAuth-Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="611b9-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="611b9-212">Flow-Schritte aus dem Abschnitt Implizite Hilfe</span><span class="sxs-lookup"><span data-stu-id="611b9-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="611b9-213">Der Beispieldownload führt die folgenden Schritte aus mit:</span><span class="sxs-lookup"><span data-stu-id="611b9-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="611b9-214">(A) Der Client initiiert den Flow, indem er den Benutzer-Agent des Ressourcenbesitzers an den Autorisierungsendpunkt weiterleitet.</span><span class="sxs-lookup"><span data-stu-id="611b9-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="611b9-215">Der Client enthält seinen Clientbezeichner, den angeforderten Bereich, den lokalen Status und einen Umleitungs-URI, an den der Autorisierungsserver den Benutzer-Agent zurücksendet, sobald der Zugriff gewährt (oder verweigert wird).</span><span class="sxs-lookup"><span data-stu-id="611b9-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="611b9-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="611b9-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="611b9-217">(B) Der Autorisierungsserver authentifiziert den Ressourcenbesitzer (über den Benutzer-Agent) und stellt fest, ob der Ressourcenbesitzer die Zugriffsanforderung des Clients gewährt oder ablehnt.</span><span class="sxs-lookup"><span data-stu-id="611b9-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="611b9-218">**Wenn der&gt; Benutzer Zugriff gewährt &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="611b9-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="611b9-219">(C) Unter der Annahme, dass der Ressourcenbesitzer Zugriff gewährt, leitet der Autorisierungsserver den Benutzer-Agent mithilfe des zuvor angegebenen Umleitungs-URI (in der Anforderung oder während der Clientregistrierung) an den Client zurück.</span><span class="sxs-lookup"><span data-stu-id="611b9-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="611b9-220">...</span><span class="sxs-lookup"><span data-stu-id="611b9-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="611b9-221">(D) Der Client fordert ein Zugriffstoken vom Tokenendpunkt des Autorisierungsservers an, indem er den im vorherigen Schritt empfangenen Autorisierungscode einschließt.</span><span class="sxs-lookup"><span data-stu-id="611b9-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="611b9-222">Bei der Anforderung authentifiziert sich der Client beim Autorisierungsserver.</span><span class="sxs-lookup"><span data-stu-id="611b9-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="611b9-223">Der Client enthält den Umleitungs-URI, der zum Abrufen des Autorisierungscodes zur Überprüfung verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="611b9-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="611b9-224">Da wir bereits den Autorisierungsendpunkt (Aktion)`OAuthController.Authorize` für die Berechtigungscodeerteilung implementiert haben, wird automatisch auch der implizite Fluss aktiviert.</span><span class="sxs-lookup"><span data-stu-id="611b9-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="611b9-225">Hinweis: `Provider.ValidateClientRedirectUri` wird verwendet, um die Client-ID mit ihrer Umleitungs-URL zu überprüfen, die den impliziten Grant-Fluss vor dem Senden des Zugriffstokens an böswillige Clients schützt ([Man-in-the-Middle-Angriff](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="611b9-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="611b9-226">Resource Owner Password Credentials Grant</span><span class="sxs-lookup"><span data-stu-id="611b9-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="611b9-227">Lesen Sie jetzt den Abschnitt OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) der IETF.</span><span class="sxs-lookup"><span data-stu-id="611b9-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="611b9-228">Der in Abbildung 5 [dargestellte Ressourcenbesitzerkennwortanmeldeinformationen-Grant-Flow](http://tools.ietf.org/html/rfc6749#section-4.3) ist der Flow und die Zuordnung, der die OWIN OAuth-Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="611b9-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="611b9-229">Flow-Schritte aus dem Abschnitt Ressourcenbesitzerkennwortanmeldeinformationen gewähren</span><span class="sxs-lookup"><span data-stu-id="611b9-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="611b9-230">Der Beispieldownload führt die folgenden Schritte aus mit:</span><span class="sxs-lookup"><span data-stu-id="611b9-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="611b9-231">(A) Der Ressourcenbesitzer gibt dem Client seinen Benutzernamen und sein Kennwort an.</span><span class="sxs-lookup"><span data-stu-id="611b9-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="611b9-232">(B) Der Client fordert ein Zugriffstoken vom Tokenendpunkt des Autorisierungsservers an, indem er die vom Ressourcenbesitzer empfangenen Anmeldeinformationen einschließt.</span><span class="sxs-lookup"><span data-stu-id="611b9-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="611b9-233">Bei der Anforderung authentifiziert sich der Client beim Autorisierungsserver.</span><span class="sxs-lookup"><span data-stu-id="611b9-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="611b9-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="611b9-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="611b9-235">(C) Der Autorisierungsserver authentifiziert den Client, überprüft die Anmeldeinformationen des Ressourcenbesitzers und gibt, falls gültig, ein Zugriffstoken aus.</span><span class="sxs-lookup"><span data-stu-id="611b9-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="611b9-236">Hier ist die `Provider.GrantResourceOwnerCredentials`Beispielimplementierung für:</span><span class="sxs-lookup"><span data-stu-id="611b9-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="611b9-237">Der obige Code soll diesen Abschnitt des Tutorials erklären und sollte nicht in sicheren oder Produktions-Apps verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="611b9-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="611b9-238">Die Anmeldeinformationen der Ressourcenbesitzer werden nicht überprüft.</span><span class="sxs-lookup"><span data-stu-id="611b9-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="611b9-239">Es wird davon ausgegangen, dass alle Anmeldeinformationen gültig sind, und es wird eine neue Identität für sie erstellt.</span><span class="sxs-lookup"><span data-stu-id="611b9-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="611b9-240">Die neue Identität wird verwendet, um das Zugriffstoken und das Aktualisierungstoken zu generieren.</span><span class="sxs-lookup"><span data-stu-id="611b9-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="611b9-241">Ersetzen Sie den Code durch Ihren eigenen sicheren Kontoverwaltungscode.</span><span class="sxs-lookup"><span data-stu-id="611b9-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="611b9-242">Clientcredentials Grant</span><span class="sxs-lookup"><span data-stu-id="611b9-242">Client Credentials Grant</span></span>

<span data-ttu-id="611b9-243">Lesen Sie jetzt den Abschnitt OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) der IETF.</span><span class="sxs-lookup"><span data-stu-id="611b9-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="611b9-244">Der in Abbildung 6 [dargestellte Client Credentials Grant-Flow](http://tools.ietf.org/html/rfc6749#section-4.4) ist der Flow und die Zuordnung, der die OWIN OAuth-Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="611b9-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="611b9-245">Flow-Schritte aus dem Abschnitt "Clientanmeldeinformationen gewähren"</span><span class="sxs-lookup"><span data-stu-id="611b9-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="611b9-246">Der Beispieldownload führt die folgenden Schritte aus mit:</span><span class="sxs-lookup"><span data-stu-id="611b9-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="611b9-247">(A) Der Client authentifiziert sich beim Autorisierungsserver und fordert ein Zugriffstoken vom Tokenendpunkt an.</span><span class="sxs-lookup"><span data-stu-id="611b9-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="611b9-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="611b9-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="611b9-249">(B) Der Autorisierungsserver authentifiziert den Client und gibt, falls gültig, ein Zugriffstoken aus.</span><span class="sxs-lookup"><span data-stu-id="611b9-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="611b9-250">Hier ist die `Provider.GrantClientCredentials`Beispielimplementierung für:</span><span class="sxs-lookup"><span data-stu-id="611b9-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="611b9-251">Der obige Code soll diesen Abschnitt des Tutorials erklären und sollte nicht in sicheren oder Produktions-Apps verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="611b9-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="611b9-252">Ersetzen Sie den Code durch Ihren eigenen sicheren Clientverwaltungscode.</span><span class="sxs-lookup"><span data-stu-id="611b9-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="611b9-253">Aktualisieren eines Tokens</span><span class="sxs-lookup"><span data-stu-id="611b9-253">Refresh Token</span></span>

<span data-ttu-id="611b9-254">Lesen Sie jetzt den Abschnitt OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) der IETF.</span><span class="sxs-lookup"><span data-stu-id="611b9-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="611b9-255">Der in Abbildung 2 dargestellte [Refresh-Token-Flow](http://tools.ietf.org/html/rfc6749#section-1.5) ist der Flow und die Zuordnung, der die OWIN OAuth-Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="611b9-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="611b9-256">Flow-Schritte aus dem Abschnitt "Clientanmeldeinformationen gewähren"</span><span class="sxs-lookup"><span data-stu-id="611b9-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="611b9-257">Der Beispieldownload führt die folgenden Schritte aus mit:</span><span class="sxs-lookup"><span data-stu-id="611b9-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="611b9-258">(G) Der Client fordert ein neues Zugriffstoken an, indem er sich beim Autorisierungsserver authentifiziert und das Aktualisierungstoken vorstellt.</span><span class="sxs-lookup"><span data-stu-id="611b9-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="611b9-259">Die Clientauthentifizierungsanforderungen basieren auf dem Clienttyp und den Richtlinien des Autorisierungsservers.</span><span class="sxs-lookup"><span data-stu-id="611b9-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="611b9-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="611b9-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="611b9-261">(H) Der Autorisierungsserver authentifiziert den Client und überprüft das Aktualisierungstoken und gibt, falls gültig, ein neues Zugriffstoken (und optional ein neues Aktualisierungstoken) aus.</span><span class="sxs-lookup"><span data-stu-id="611b9-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="611b9-262">Hier ist die `Provider.GrantRefreshToken`Beispielimplementierung für:</span><span class="sxs-lookup"><span data-stu-id="611b9-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="611b9-263">Erstellen eines Ressourcenservers, der durch Zugriffstoken geschützt ist</span><span class="sxs-lookup"><span data-stu-id="611b9-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="611b9-264">Erstellen Sie ein leeres Web-App-Projekt, und installieren Sie die folgenden Pakete im Projekt:</span><span class="sxs-lookup"><span data-stu-id="611b9-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="611b9-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="611b9-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="611b9-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="611b9-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="611b9-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="611b9-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="611b9-268">Erstellen Sie eine Startklasse, und konfigurieren Sie die Authentifizierung und web-API.</span><span class="sxs-lookup"><span data-stu-id="611b9-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="611b9-269">Siehe *AuthorizationServer-ResourceServer-Startup.cs* im Beispieldownload.</span><span class="sxs-lookup"><span data-stu-id="611b9-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="611b9-270">Weitere Informationen finden Sie im *Beispieldownload unter\_AuthorizationServer-ResourceServer-App-Start-Start-Start.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="611b9-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="611b9-271">Weitere Informationen finden Sie im *Beispieldownload unter\_AuthorizationServer-ResourceServer-App-Start-Start.WebApi.cs.*</span><span class="sxs-lookup"><span data-stu-id="611b9-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="611b9-272">`UseCors`ermöglicht CORS für alle Domänen.</span><span class="sxs-lookup"><span data-stu-id="611b9-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="611b9-273">`UseOAuthBearerAuthentication`Die Methode aktiviert OAuth Bearer-Token-Authentifizierungsmiddleware, die Das Bärentoken vom Autorisierungsheader in der Anforderung empfängt und validiert.</span><span class="sxs-lookup"><span data-stu-id="611b9-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="611b9-274">`Config.SuppressDefaultHostAuthenticaiton`unterdrückt den standardmäßigen authentifizierten Prinzipal des Hosts aus der App, daher werden alle Anforderungen nach diesem Aufruf anonym.</span><span class="sxs-lookup"><span data-stu-id="611b9-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="611b9-275">`HostAuthenticationFilter`aktiviert die Authentifizierung nur für den angegebenen Authentifizierungstyp.</span><span class="sxs-lookup"><span data-stu-id="611b9-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="611b9-276">In diesem Fall ist es Träger-Authentifizierungstyp.</span><span class="sxs-lookup"><span data-stu-id="611b9-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="611b9-277">Um die authentifizierte Identität zu demonstrieren, erstellen wir einen ApiController, um die Ansprüche des aktuellen Benutzers auszugeben.</span><span class="sxs-lookup"><span data-stu-id="611b9-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="611b9-278">Wenn sich der Autorisierungsserver und der Ressourcenserver nicht auf demselben Computer befinden, verwendet die OAuth-Middleware die verschiedenen Computerschlüssel, um das Inhaberzugriffstoken zu verschlüsseln und zu entschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="611b9-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="611b9-279">Um den gleichen privaten Schlüssel zwischen beiden Projekten `machinekey` zu teilen, fügen wir die gleiche Einstellung in beiden *web.config-Dateien* hinzu.</span><span class="sxs-lookup"><span data-stu-id="611b9-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="611b9-280">Erstellen von OAuth 2.0-Clients</span><span class="sxs-lookup"><span data-stu-id="611b9-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="611b9-281">Wir verwenden das [Paket DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet, um den Clientcode zu vereinfachen.</span><span class="sxs-lookup"><span data-stu-id="611b9-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="611b9-282">Autorisierungscode gewähren Client</span><span class="sxs-lookup"><span data-stu-id="611b9-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="611b9-283">Dieser Client ist eine MVC-Anwendung.</span><span class="sxs-lookup"><span data-stu-id="611b9-283">This client is an MVC application.</span></span> <span data-ttu-id="611b9-284">Es löst einen Autorisierungscodegrantfluss aus, um das Zugriffstoken vom Back-End abzurufen.</span><span class="sxs-lookup"><span data-stu-id="611b9-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="611b9-285">Es hat eine einzige Seite, wie unten gezeigt:</span><span class="sxs-lookup"><span data-stu-id="611b9-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="611b9-286">Die Schaltfläche **Autorisieren** leitet den Browser an den Autorisierungsserver um, um den Ressourcenbesitzer zu benachrichtigen, zugriff auf diesen Client zu gewähren.</span><span class="sxs-lookup"><span data-stu-id="611b9-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="611b9-287">Die **Schaltfläche Aktualisieren** erhält ein neues Zugriffstoken und ein Aktualisierungstoken mit dem aktuellen Aktualisierungstoken.</span><span class="sxs-lookup"><span data-stu-id="611b9-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="611b9-288">Die Access **Protected Resource API-Schaltfläche** ruft den Ressourcenserver auf, um die Anspruchsdaten des aktuellen Benutzers abzurufen und auf der Seite anzuzeigen.</span><span class="sxs-lookup"><span data-stu-id="611b9-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="611b9-289">Hier ist der Beispielcode des `HomeController` Clients.</span><span class="sxs-lookup"><span data-stu-id="611b9-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="611b9-290">`DotNetOpenAuth`erfordert standardmäßig SSL.</span><span class="sxs-lookup"><span data-stu-id="611b9-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="611b9-291">Da unsere Demo HTTP verwendet, müssen Sie in der Konfigurationsdatei folgende Einstellung hinzufügen:</span><span class="sxs-lookup"><span data-stu-id="611b9-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="611b9-292">Sicherheit - Deaktivieren Sie SSL niemals in einer Produktions-App.</span><span class="sxs-lookup"><span data-stu-id="611b9-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="611b9-293">Ihre Anmeldeinformationen werden jetzt im Klartext über den Draht gesendet.</span><span class="sxs-lookup"><span data-stu-id="611b9-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="611b9-294">Der obige Code ist nur für lokales Beispiel-Debugging und Exploration.</span><span class="sxs-lookup"><span data-stu-id="611b9-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="611b9-295">Impliziter Grant-Client</span><span class="sxs-lookup"><span data-stu-id="611b9-295">Implicit Grant Client</span></span>

<span data-ttu-id="611b9-296">Dieser Client verwendet JavaScript, um:</span><span class="sxs-lookup"><span data-stu-id="611b9-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="611b9-297">Öffnen Sie ein neues Fenster, und leiten Sie es zum Autorisierungsendpunkt des Autorisierungsservers um.</span><span class="sxs-lookup"><span data-stu-id="611b9-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="611b9-298">Rufen Sie das Zugriffstoken aus URL-Fragmenten ab, wenn es zurückleitet.</span><span class="sxs-lookup"><span data-stu-id="611b9-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="611b9-299">Die folgende Abbildung zeigt diesen Prozess:</span><span class="sxs-lookup"><span data-stu-id="611b9-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="611b9-300">Der Client sollte zwei Seiten haben: eine für die Homepage und die andere für den Rückruf. Hier ist das Beispiel JavaScript-Code in der *Datei Index.cshtml* gefunden:</span><span class="sxs-lookup"><span data-stu-id="611b9-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="611b9-301">Hier ist der Rückrufbehandlungscode in *der Datei SignIn.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="611b9-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="611b9-302">Es wird jedoch dringend verfahren, JavaScript in eine externe Datei zu verschieben und nicht in das Razor-Markup einzubetten.</span><span class="sxs-lookup"><span data-stu-id="611b9-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="611b9-303">Um diese Probe einfach zu halten, wurden sie kombiniert.</span><span class="sxs-lookup"><span data-stu-id="611b9-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="611b9-304">Ressourcenbesitzer-Kennwortanmeldeinformationen gewähren Client</span><span class="sxs-lookup"><span data-stu-id="611b9-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="611b9-305">Wir verwenden eine Konsolen-App, um diesen Client vorzuführen.</span><span class="sxs-lookup"><span data-stu-id="611b9-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="611b9-306">Hier folgt der Code:</span><span class="sxs-lookup"><span data-stu-id="611b9-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="611b9-307">Clientanmeldeinformationen gewähren Client</span><span class="sxs-lookup"><span data-stu-id="611b9-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="611b9-308">Ähnlich wie bei der Resource Owner Password Credentials Grant, hier ist Konsolen-App-Code:</span><span class="sxs-lookup"><span data-stu-id="611b9-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
