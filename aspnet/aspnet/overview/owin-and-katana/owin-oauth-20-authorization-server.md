---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: OWIN OAuth 2.0-Autorisierungsserver | Microsoft-Dokumentation
author: hongyes
description: Dieses Tutorial führt Sie zum Implementieren von OAuth 2.0-Autorisierungsserver mit OWIN-OAuth-Middleware. Dies ist ein erweitertes Lernprogramm, nur Outlin...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: 6523d09e41fe10475d1bcb7fca06b2e0e2d3182c
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 05/06/2019
ms.locfileid: "65118200"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="b0ed9-104">OWIN-OAuth 2.0-Autorisierungsserver</span><span class="sxs-lookup"><span data-stu-id="b0ed9-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="b0ed9-105">Dieses Tutorial führt Sie zum Implementieren von OAuth 2.0-Autorisierungsserver mit OWIN-OAuth-Middleware.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="b0ed9-106">Dies ist eine erweiterte Tutorial, in dem nur die Schritte zum Erstellen einer OWIN OAuth 2.0-Autorisierungsserver erläutert.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="b0ed9-107">Dies ist keine Schritt-für-Schritt-Tutorial.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="b0ed9-108">[Beispielcode herunterladen](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="b0ed9-109">Dieser Umriss sollte nicht dazu vorgesehen werden, zum Erstellen einer sicheren Produktions-Apps verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="b0ed9-110">Dieses Tutorial soll nur einen Umriss zum Implementieren von OAuth 2.0-Autorisierungsserver mit OWIN-OAuth-Middleware zu bieten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="b0ed9-111">Software-Versionen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-111">Software versions</span></span>
>
> | <span data-ttu-id="b0ed9-112">**In diesem Tutorial gezeigt**</span><span class="sxs-lookup"><span data-stu-id="b0ed9-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="b0ed9-113">**Funktioniert auch mit**</span><span class="sxs-lookup"><span data-stu-id="b0ed9-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="b0ed9-114">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="b0ed9-114">Windows 8.1</span></span> | <span data-ttu-id="b0ed9-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="b0ed9-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="b0ed9-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="b0ed9-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="b0ed9-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="b0ed9-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="b0ed9-118">Fragen und Kommentare</span><span class="sxs-lookup"><span data-stu-id="b0ed9-118">Questions and comments</span></span>
>
> <span data-ttu-id="b0ed9-119">Wenn Sie Fragen, die nicht direkt mit dem Tutorial verknüpft sind haben, können Sie diese unter buchen [Katana-Projekt auf GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="b0ed9-120">Finden Sie für Fragen und Kommentare in Bezug auf das Tutorial selbst im Kommentarabschnitt "am unteren Rand der Seite.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>

<span data-ttu-id="b0ed9-121">Die [OAuth 2.0-Framework](http://tools.ietf.org/html/rfc6749) können Sie eine Drittanbieter-app zum eingeschränkten Zugriff auf einen HTTP-Dienst abrufen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="b0ed9-122">Nicht der Besitzer der Ressource der Anmeldeinformationen auf eine geschützte Ressource zuzugreifen, ruft der Client ein Zugriffstoken ab (Dies ist eine Zeichenfolge, die einen bestimmten Bereich, Lebensdauer und andere Zugriffsattribute bezeichnet).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="b0ed9-123">Zugriffstoken werden mit der Genehmigung des ressourcenbesitzers für Drittanbieter-Clients von einem autorisierungsserver ausgegeben.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="b0ed9-124">In diesem Tutorial werden behandelt:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-124">This tutorial will cover:</span></span>

- <span data-ttu-id="b0ed9-125">Vorgehensweise: Erstellen von einem autorisierungsserver zur Unterstützung von vier Autorisierung gewährungstypen und Aktualisieren von Token:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="b0ed9-126">Authorization Code grant</span><span class="sxs-lookup"><span data-stu-id="b0ed9-126">Authorization code grant</span></span>
    - <span data-ttu-id="b0ed9-127">Die implizite Gewährung</span><span class="sxs-lookup"><span data-stu-id="b0ed9-127">Implicit Grant</span></span>
    - <span data-ttu-id="b0ed9-128">Kennwort des Ressourcenbesitzers Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="b0ed9-129">Gewährung von Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-129">Client Credentials Grant</span></span>
- <span data-ttu-id="b0ed9-130">Erstellen einen Ressourcenserver, die durch ein Zugriffstoken für den geschützt ist.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="b0ed9-131">Erstellen von OAuth 2.0-Clients.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="b0ed9-132">Vorraussetzungen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-132">Prerequisites</span></span>

- <span data-ttu-id="b0ed9-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) gemäß **Softwareversionen** am oberen Rand der Seite.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="b0ed9-134">Vertrautheit mit OWIN.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-134">Familiarity with OWIN.</span></span> <span data-ttu-id="b0ed9-135">Finden Sie unter [erste Schritte mit dem Katana-Projekt](https://msdn.microsoft.com/magazine/dn451439.aspx) und [Neuigkeiten in der OWIN und Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="b0ed9-136">Vertrautheit mit [OAuth](http://tools.ietf.org/html/rfc6749) Terminologie, einschließlich [Rollen](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), und [Gewährung der Autorisierung](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="b0ed9-137">[Einführung in die OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) bietet eine gute Einführung in.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="b0ed9-138">Einen Autorisierungsserver erstellen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-138">Create an Authorization Server</span></span>

<span data-ttu-id="b0ed9-139">In diesem Tutorial werden wir ungefähr, wie Sie mit skizzieren [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) und ASP.NET MVC zum Erstellen von eines autorisierungsservers.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="b0ed9-140">Wir hoffen, geben Sie einen Download für das vollständige Beispiel, in Kürze, wie in diesem Tutorial nicht in jedem Schritt enthalten ist.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="b0ed9-141">Erstellen Sie zunächst eine leere Web-app, die mit dem Namen *AuthorizationServer* herunter, und installieren Sie die folgenden Pakete:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="b0ed9-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="b0ed9-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="b0ed9-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="b0ed9-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="b0ed9-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="b0ed9-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="b0ed9-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="b0ed9-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="b0ed9-146">Microsoft.Owin.Security.Google (oder jede andere Anmeldung für soziale Netzwerke wie z. B. Microsoft.Owin.Security.Facebook-Paket)</span><span class="sxs-lookup"><span data-stu-id="b0ed9-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="b0ed9-147">Hinzufügen einer [OWIN-Startklasse](owin-startup-class-detection.md) unter dem Stammordner des Projekts mit dem Namen *Start*.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="b0ed9-148">Erstellen Sie eine *App\_starten* Ordner.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="b0ed9-149">Wählen Sie die *App\_starten* Ordner und verwenden Sie Umschalt + Alt + A, Hinzufügen der heruntergeladene Version der *AuthorizationServer\App\_Start\Startup.Auth.cs* Datei.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="b0ed9-150">Der obige Code ermöglicht die Anwendung/eine externe Anmeldung Cookies und Google-Authentifizierung, die vom autorisierungsserver selbst verwendet werden, um Konten zu verwalten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="b0ed9-151">Die `UseOAuthAuthorizationServer` Erweiterungsmethode ist den autorisierungsserver einrichten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="b0ed9-152">Die Setupoptionen sind:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-152">The setup options are:</span></span>

- <span data-ttu-id="b0ed9-153">`AuthorizeEndpointPath`: Der Anforderungspfad, in denen Clientanwendungen User-Agent umgeleitet wird, um die Benutzer erhalten, stimmen ein Token oder Code ausgeben.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="b0ed9-154">Es muss beginnen mit einem führenden Schrägstrich, z. B. "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="b0ed9-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="b0ed9-155">`TokenEndpointPath`: Die Anforderung Pfad-Clientanwendungen kommunizieren direkt zum Abrufen des Zugriffstokens.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="b0ed9-156">Es muss mit einem führenden Schrägstrich, z. B. "/ Token" beginnen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="b0ed9-157">Wenn der Client ausgestellt wird eine [Client\_geheimen Schlüssel](http://tools.ietf.org/html/rfc6749#appendix-A.2), muss an diesen Endpunkt bereitgestellt werden.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="b0ed9-158">`ApplicationCanDisplayErrors`: Legen Sie auf `true` Wenn möchte, dass die Webanwendung auf eine benutzerdefinierten Fehlerseite für den clientvalidierungsfehler generieren `/Authorize` Endpunkt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="b0ed9-159">Dies ist nur erforderlich, für Fälle, in dem der Browser wird nicht umgeleitet, an die Clientanwendung, z. B. sichern, wenn die `client_id` oder `redirect_uri` sind falsch.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="b0ed9-160">Die `/Authorize` Endpunkt sollte aber in den "Oauth. Fehler","Oauth. ErrorDescription"und"Oauth. Argument ErrorUri"-Eigenschaften werden in der OWIN-Umgebung hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="b0ed9-161">Wenn nicht "true", der autorisierungsserver gibt eine Standardfehlerseite mit den Fehlerdetails.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="b0ed9-162">`AllowInsecureHttp`: True, um zuzulassen, Autorisierungs- und tokenanforderungen für HTTP-URI-Adressen eingehen und eingehende `redirect_uri` autorisieren Anforderungsparameter, um HTTP-URI-Adressen verfügen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="b0ed9-163">Sicherheit – ist dies nur für die Entwicklung.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-163">Security - This is for development only.</span></span>
- <span data-ttu-id="b0ed9-164">`Provider`: Das Objekt bereitgestellt, die von der Anwendung zum Verarbeiten von Ereignissen, die von der autorisierungsservermiddleware ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="b0ed9-165">Die Anwendung kann die Schnittstelle vollständig implementieren oder es möglicherweise erstellen Sie eine Instanz des `OAuthAuthorizationServerProvider` und Zuweisen von Delegaten, die für die OAuth-Flows, die dieser Server unterstützt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="b0ed9-166">`AuthorizationCodeProvider`: Erstellt einen einmaligen Verwendung Autorisierungscode an die Clientanwendung zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="b0ed9-167">Sichern Sie die Anwendung für die OAuth-Server **müssen** stellen eine Instanz für `AuthorizationCodeProvider` , in dem das Token erstellt, indem die `OnCreate/OnCreateAsync` Ereignis gilt für nur einen Aufruf von `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="b0ed9-168">`RefreshTokenProvider`: Generiert ein Aktualisierungstoken, das verwendet werden kann, um ein neues Zugriffstoken bei Bedarf zu erzeugen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="b0ed9-169">Wenn nicht angegeben. der autorisierungsserver keine Aktualisierungstoken aus zurück der `/Token` Endpunkt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="b0ed9-170">Kontoverwaltung</span><span class="sxs-lookup"><span data-stu-id="b0ed9-170">Account Management</span></span>

<span data-ttu-id="b0ed9-171">OAuth ist unerheblich, wo und wie Sie Ihre Kontoinformationen der Benutzer verwalten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="b0ed9-172">Sie verfügt über [ASP.NET Identity](../../../identity/index.md) ist dafür zuständig.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="b0ed9-173">In diesem Tutorial haben wir den Konto Management Code vereinfachen und achten Sie darauf, dass sich der Benutzer anmelden kann mithilfe von OWIN Cookie-Middleware.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="b0ed9-174">Hier ist der vereinfachte Code für die `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="b0ed9-175">`ValidateClientRedirectUri` wird verwendet, um den Client mit der registrierte umleitungs-URL zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="b0ed9-176">`ValidateClientAuthentication` überprüft die basic-Schema-Header und Formulartext, um die Anmeldeinformationen des Clients zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="b0ed9-177">Die Anmeldeseite wird unten gezeigt:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="b0ed9-178">Überprüfen Sie der IETF OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="b0ed9-179">**Anbieter** (in der Tabelle unten) ist der [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Anbieter, der vom Typ `OAuthAuthorizationServerProvider`, die alle OAuth-Server-Ereignisse enthält.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="b0ed9-180">Authorization Code Grant-Abschnitt die einzelnen Schritte</span><span class="sxs-lookup"><span data-stu-id="b0ed9-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="b0ed9-181">Beispiel zum Herunterladen führt diese Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b0ed9-182">(A) der Client initiiert den Flow, indem die vom Benutzer-Agent des ressourcenbesitzers an den autorisierungsendpunkt umleiten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="b0ed9-183">Der Client enthält, der Clientbezeichner, angeforderten Bereich, lokalen Status und einen umleitungs-URI, der an den der autorisierungsserver den Benutzer-Agent sendet zurück, sobald der Zugriff gewährt (oder verweigert) wird.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="b0ed9-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="b0ed9-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-185">(B) der autorisierungsserver authentifiziert den Ressourcenbesitzer (über den Benutzer-Agent) und legt fest, ob der Besitzer der Ressource gewährt oder die Anforderung des Clients den Zugriff verweigert.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="b0ed9-186">**&lt;Wenn Benutzer den Zugriff gewährt&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b0ed9-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-187">(C) vorausgesetzt der Ressourcenbesitzer Zugriff gewährt, der autorisierungsserver leitet den Benutzer-Agent zurück an den Client mit der umleitungs-URI angegeben (in der Anforderung oder während der Clientregistrierung) früher.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="b0ed9-188">...</span><span class="sxs-lookup"><span data-stu-id="b0ed9-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="b0ed9-189">(D) der Client fordert ein Zugriffstoken vom tokenendpunkt des autorisierungsservers mit den im vorherigen Schritt empfangene Autorisierungscode.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="b0ed9-190">Wenn die Anforderung ausführen, authentifiziert der Client beim autorisierungsserver.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="b0ed9-191">Der Client enthält den Redirection, den URI verwendet, um den Autorisierungscode für die Überprüfung zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="b0ed9-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b0ed9-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="b0ed9-193">Eine beispielimplementierung für `AuthorizationCodeProvider.CreateAsync` und `ReceiveAsync` steuern die Erstellung und Überprüfung der Autorisierungscode wird unten angezeigt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="b0ed9-194">Der obige Code verwendet ein parallele in-Memory-Wörterbuch, um das Ticket Code und die Identität zu speichern und Wiederherstellen von die Identität nach dem Empfang des Codes.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="b0ed9-195">In einer echten Anwendung würden sie von einem persistenten Datenspeicher ersetzt werden.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="b0ed9-196">Der autorisierungsendpunkt wird für den Besitzer der Ressource gewähren von Zugriff an den Client.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="b0ed9-197">In der Regel benötigt eine Benutzeroberfläche, damit Benutzer auf eine Schaltfläche klicken und die Zuweisung zu bestätigen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="b0ed9-198">OWIN-OAuth-Middleware kann Anwendungscode, um den autorisierungsendpunkt zu behandeln.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="b0ed9-199">In unserem Beispiel-app, die wir verwenden eines MVC-Controllers namens `OAuthController` verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="b0ed9-200">Dies ist die beispielimplementierung:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="b0ed9-201">Die `Authorize` Aktion zunächst überprüft, ob der Benutzer an den autorisierungsserver angemeldet hat.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="b0ed9-202">Wenn dies nicht der Fall, die authentifizierungsmiddleware Herausforderungen bei der Aufrufer für die Authentifizierung mit das Cookie "Application" und auf die Anmeldeseite umgeleitet.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="b0ed9-203">(Siehe oben hervorgehobenen Code). Wenn der Benutzer angemeldet hat, wird es die Authorize-Ansicht rendern, wie unten dargestellt:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="b0ed9-204">Wenn die **Grant** ausgewählt ist, die `Authorize` Aktion wird eine neue "Bearer" Identität und melden Sie sich mit der sie erstellt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="b0ed9-205">Löst den autorisierungsserver generiert ein trägertoken, das und zurück an den Client mit JSON-Nutzlast zu senden.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="b0ed9-206">Die implizite Gewährung</span><span class="sxs-lookup"><span data-stu-id="b0ed9-206">Implicit Grant</span></span>

<span data-ttu-id="b0ed9-207">Finden Sie in der IETF OAuth 2 [implizite Gewährung](http://tools.ietf.org/html/rfc6749#section-4.2) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="b0ed9-208">Die [implizite Gewährung](http://tools.ietf.org/html/rfc6749#section-4.2) dargestellt in Abbildung 4 ist der Flow und Middleware Zuordnen der OWIN-OAuth folgt auf.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="b0ed9-209">Schritte im Abschnitt die implizite Gewährung des Datenflusses</span><span class="sxs-lookup"><span data-stu-id="b0ed9-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="b0ed9-210">Beispiel zum Herunterladen führt diese Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b0ed9-211">(A) der Client initiiert den Flow, indem die vom Benutzer-Agent des ressourcenbesitzers an den autorisierungsendpunkt umleiten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="b0ed9-212">Der Client enthält, der Clientbezeichner, angeforderten Bereich, lokalen Status und einen umleitungs-URI, der an den der autorisierungsserver den Benutzer-Agent sendet zurück, sobald der Zugriff gewährt (oder verweigert) wird.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="b0ed9-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="b0ed9-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-214">(B) der autorisierungsserver authentifiziert den Ressourcenbesitzer (über den Benutzer-Agent) und legt fest, ob der Besitzer der Ressource gewährt oder die Anforderung des Clients den Zugriff verweigert.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="b0ed9-215">**&lt;Wenn Benutzer den Zugriff gewährt&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b0ed9-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-216">(C) vorausgesetzt der Ressourcenbesitzer Zugriff gewährt, der autorisierungsserver leitet den Benutzer-Agent zurück an den Client mit der umleitungs-URI angegeben (in der Anforderung oder während der Clientregistrierung) früher.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="b0ed9-217">...</span><span class="sxs-lookup"><span data-stu-id="b0ed9-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="b0ed9-218">(D) der Client fordert ein Zugriffstoken vom tokenendpunkt des autorisierungsservers mit den im vorherigen Schritt empfangene Autorisierungscode.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="b0ed9-219">Wenn die Anforderung ausführen, authentifiziert der Client beim autorisierungsserver.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="b0ed9-220">Der Client enthält den Redirection, den URI verwendet, um den Autorisierungscode für die Überprüfung zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="b0ed9-221">Da wir bereits den autorisierungsendpunkt implementiert (`OAuthController.Authorize` Aktion) für die autorisierungscodegewährung, es ebenfalls impliziten Fluss automatisch aktiviert.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="b0ed9-222">Hinweis: `Provider.ValidateClientRedirectUri` wird verwendet, um die Client-ID mit der umleitungs-URL, zu überprüfen, bei denen der impliziten Gewährung schützt, senden Sie den Zugriff-Token genutzt, um böswillige Clients ([Man-in-the-Middle-Angriff](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="b0ed9-223">Kennwort des Ressourcenbesitzers Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="b0ed9-224">Finden Sie in der IETF OAuth 2 [Kennwort-Anmeldeinformationen-Ressourcenbesitzererteilung](http://tools.ietf.org/html/rfc6749#section-4.3) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="b0ed9-225">Die [Kennwort-Anmeldeinformationen-Ressourcenbesitzererteilung](http://tools.ietf.org/html/rfc6749#section-4.3) dargestellt in Abbildung 5 ist der Flow und Middleware Zuordnen der OWIN-OAuth folgt auf.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="b0ed9-226">Resource Owner Password Gewährung von Clientanmeldeinformationen im Abschnitt die einzelnen Schritte</span><span class="sxs-lookup"><span data-stu-id="b0ed9-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="b0ed9-227">Beispiel zum Herunterladen führt diese Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b0ed9-228">(A) der Besitzer der Ressource bereitgestellt dem Client, mit dessen Benutzername und Kennwort.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="b0ed9-229">(B) der Client fordert ein Zugriffstoken vom tokenendpunkt des autorisierungsservers, dazu die Anmeldeinformationen des ressourcenbesitzers empfangen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="b0ed9-230">Wenn die Anforderung ausführen, authentifiziert der Client beim autorisierungsserver.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="b0ed9-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b0ed9-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-232">(C) der autorisierungsserver authentifiziert den Client überprüft die Anmeldeinformationen des Resource Owner, und wenn gültig ist, gibt ein Zugriffstoken.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="b0ed9-233">Hier ist die Implementierung des Beispiels für `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="b0ed9-234">Der obige Code sollte in diesem Abschnitt des Tutorials erläutert und sollte nicht verwendet werden, in der sicheren oder Produktions-apps.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="b0ed9-235">Es wird nicht der Besitzer ressourcenanmeldeinformationen überprüft.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="b0ed9-236">Es wird vorausgesetzt, alle Anmeldeinformationen gültig ist und erstellt eine neue Identität für diese.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="b0ed9-237">Die neue Identität wird generieren das Zugriffstoken und Aktualisierungstoken verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="b0ed9-238">Ersetzen Sie den Code mit Ihrem eigenen sicheren Account Management-Code ein.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-238">Please replace the code with your own secure account management code.</span></span>

### <a name="client-credentials-grant"></a><span data-ttu-id="b0ed9-239">Gewährung von Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="b0ed9-239">Client Credentials Grant</span></span>

<span data-ttu-id="b0ed9-240">Finden Sie in der IETF OAuth 2 [Gewährung von Clientanmeldeinformationen](http://tools.ietf.org/html/rfc6749#section-4.4) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="b0ed9-241">Die [Gewährung von Clientanmeldeinformationen](http://tools.ietf.org/html/rfc6749#section-4.4) dargestellt in Abbildung 6 ist der Flow und Middleware Zuordnen der OWIN-OAuth folgt auf.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="b0ed9-242">Gewährung von Clientanmeldeinformationen im Abschnitt die einzelnen Schritte</span><span class="sxs-lookup"><span data-stu-id="b0ed9-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="b0ed9-243">Beispiel zum Herunterladen führt diese Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b0ed9-244">(A) der Client authentifiziert sich mit dem autorisierungsserver und fordert ein Zugriffstoken vom tokenendpunkt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="b0ed9-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b0ed9-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-246">(B) der autorisierungsserver authentifiziert den Client, und wenn gültig ist, gibt ein Zugriffstoken.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="b0ed9-247">Hier ist die Implementierung des Beispiels für `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="b0ed9-248">Der obige Code sollte in diesem Abschnitt des Tutorials erläutert und sollte nicht verwendet werden, in der sicheren oder Produktions-apps.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="b0ed9-249">Ersetzen Sie den Code mit Ihrem eigenen sichere Client-Management-Code ein.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-249">Please replace the code with your own secure client management code.</span></span>

### <a name="refresh-token"></a><span data-ttu-id="b0ed9-250">Aktualisierungstoken</span><span class="sxs-lookup"><span data-stu-id="b0ed9-250">Refresh Token</span></span>

<span data-ttu-id="b0ed9-251">Finden Sie in der IETF OAuth 2 [Aktualisierungstoken](http://tools.ietf.org/html/rfc6749#section-1.5) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="b0ed9-252">Die [Aktualisierungstoken](http://tools.ietf.org/html/rfc6749#section-1.5) dargestellt in Abbildung 2 ist der Flow und Middleware Zuordnen der OWIN-OAuth folgt auf.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="b0ed9-253">Gewährung von Clientanmeldeinformationen im Abschnitt die einzelnen Schritte</span><span class="sxs-lookup"><span data-stu-id="b0ed9-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="b0ed9-254">Beispiel zum Herunterladen führt diese Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="b0ed9-255">(G) der Client fordert ein neues Zugriffstoken, durch die Authentifizierung mit dem autorisierungsserver und das Aktualisierungstoken, das darstellen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="b0ed9-256">Die Client-authentifizierungsanforderungen basieren auf dem Client und auf den Autorisierungsrichtlinien für den Server.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="b0ed9-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="b0ed9-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="b0ed9-258">(H) der autorisierungsserver authentifiziert den Client das Aktualisierungstoken, das überprüft, und gültig ist, gibt ein neues Zugriffstoken (und optional ein neues Aktualisierungstoken).</span><span class="sxs-lookup"><span data-stu-id="b0ed9-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="b0ed9-259">Hier ist die Implementierung des Beispiels für `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="b0ed9-260">Erstellen Sie einen Ressourcen-Server, die durch Access-Token geschützt wird</span><span class="sxs-lookup"><span data-stu-id="b0ed9-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="b0ed9-261">Erstellen Sie eine leere Web-app-Projekt, und folgende Pakete im Projekt installieren:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="b0ed9-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="b0ed9-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="b0ed9-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="b0ed9-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="b0ed9-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="b0ed9-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="b0ed9-265">Erstellen Sie eine Startup-Klasse, und Konfigurieren von Authentifizierung und Web-API.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="b0ed9-266">Finden Sie unter *AuthorizationServer\ResourceServer\Startup.cs* im Downloadbeispiel.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="b0ed9-267">Finden Sie unter *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* im Downloadbeispiel.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="b0ed9-268">Finden Sie unter *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* im Downloadbeispiel.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="b0ed9-269">`UseCors` Methode können CORS für alle Domänen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="b0ed9-270">`UseOAuthBearerAuthentication` Methode können OAuth Bearer-token-Authentifizierung-Middleware empfangen und Überprüfen von bearertoken aus der "Authorization"-Header in der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="b0ed9-271">`Config.SuppressDefaultHostAuthentication` Unterdrückt die standardmäßige authentifizierten Prinzipal aus der app zu hosten, daher alle Anforderungen werden anonyme nach diesem Aufruf.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-271">`Config.SuppressDefaultHostAuthentication` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="b0ed9-272">`HostAuthenticationFilter` ermöglicht die Authentifizierung nur für den angegebenen Authentifizierungstyp.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="b0ed9-273">In diesem Fall ist es an der bearerauthentifizierungstyp.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="b0ed9-274">Um die authentifizierte Identität zu veranschaulichen, erstellen wir ein ApiController-Element des aktuellen Benutzers Ansprüche ausgeben.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="b0ed9-275">Wenn der autorisierungsserver und der Ressourcenserver nicht auf demselben Computer sind, verwendet die OAuth-Middleware die anderen Computerschlüssel zum Verschlüsseln und Entschlüsseln von bearertoken für Zugriff.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="b0ed9-276">Um den gleichen privaten Schlüssel zwischen den beiden Projekten verwenden zu können, fügen wir gleich `machinekey` festlegen, die in beiden *"Web.config"* Dateien.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="b0ed9-277">Erstellen von OAuth 2.0-Clients</span><span class="sxs-lookup"><span data-stu-id="b0ed9-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="b0ed9-278">Wir verwenden die [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet-Paket, um den Clientcode zu vereinfachen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="b0ed9-279">Authorization Code Grant-Client</span><span class="sxs-lookup"><span data-stu-id="b0ed9-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="b0ed9-280">Dieser Client ist eine MVC-Anwendung.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-280">This client is an MVC application.</span></span> <span data-ttu-id="b0ed9-281">Es wird einen Authorization Code Grant-Datenfluss um den Back-End-Abrufen des Zugriffstokens von ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="b0ed9-282">Es verfügt über eine einzelne Seite, wie unten dargestellt:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="b0ed9-283">Die **autorisieren** Schaltfläche werden Browser umgeleitet werden, mit dem autorisierungsserver, um den Besitzer der Ressource, um Zugriff auf diesen Client zu benachrichtigen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="b0ed9-284">Die **aktualisieren** Schaltfläche erhalten ein neues Zugriffstoken und Aktualisierungstoken, das die aktuelle Aktualisierung mit token.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="b0ed9-285">Die **Zugriff geschützte Ressource API** Schaltfläche wird den Ressourcenserver zum Abrufen von Daten von Ansprüchen des aktuellen Benutzers, und zeigen sie auf der Seite aufrufen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="b0ed9-286">Hier ist der Beispielcode die `HomeController` des Clients.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="b0ed9-287">`DotNetOpenAuth` erfordert SSL standardmäßig.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="b0ed9-288">Da unsere Demo HTTP verwendet wird, müssen Sie fügen folgende Einstellung in der Config-Datei:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="b0ed9-289">Sicherheit – nie deaktivieren SSL in einer Produktions-app.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="b0ed9-290">Ihre Anmeldeinformationen werden jetzt im Klartext über das Netzwerk gesendet wird.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="b0ed9-291">Der obige Code ist nur für lokale Beispiel zu debuggen und durchsuchen.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-291">The code above is just for local sample debugging and exploration.</span></span>

### <a name="implicit-grant-client"></a><span data-ttu-id="b0ed9-292">Implizite Gewährung-Client</span><span class="sxs-lookup"><span data-stu-id="b0ed9-292">Implicit Grant Client</span></span>

<span data-ttu-id="b0ed9-293">Dieser Client verwendet JavaScript:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="b0ed9-294">Öffnen Sie ein neues Fenster, und leiten Sie an den autorisierungsendpunkt des Autorisierungsservers.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="b0ed9-295">Abrufen des Zugriffstokens aus URL-Fragmenten, wenn es wieder leitet.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="b0ed9-296">Die folgende Abbildung veranschaulicht diesen Prozess:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="b0ed9-297">Der Client sollte über zwei Seiten verfügen: eine für die Startseite und der andere für den Rückruf. So sieht die Beispiel-JavaScript-Code finden Sie in der *"Index.cshtml"* Datei:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="b0ed9-298">Hier ist der Rückruf, der Verarbeitung von Code in *SignIn.cshtml* Datei:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="b0ed9-299">Eine bewährte Methode ist, verschieben den JavaScript-Code in eine externe Datei, und diese nicht mit dem Razor-Markup einzubetten.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="b0ed9-300">Um dieses Beispiel einfach zu halten, wurden sie kombiniert.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-300">To keep this sample simple, they have been combined.</span></span>

### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="b0ed9-301">Kennwort des Ressourcenbesitzers Credentials Grant-Client</span><span class="sxs-lookup"><span data-stu-id="b0ed9-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="b0ed9-302">Wir verwendet eine Konsolen-app, um diesen Client-demo.</span><span class="sxs-lookup"><span data-stu-id="b0ed9-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="b0ed9-303">Hier ist der Code ein:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="b0ed9-304">Client Credentials Grant-Client</span><span class="sxs-lookup"><span data-stu-id="b0ed9-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="b0ed9-305">Ähnlich wie die Kennwort-Anmeldeinformationen-Ressourcenbesitzererteilung, hier ist Console app-Code:</span><span class="sxs-lookup"><span data-stu-id="b0ed9-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
