---
uid: web-api/overview/security/authentication-filters
title: Authentifizierungs Filter in ASP.net-Web-API 2 | Microsoft-Dokumentation
author: MikeWasson
description: Ein Authentifizierungs Filter ist eine Komponente, die eine HTTP-Anforderung authentifiziert. Die Web-API 2 und MVC 5 unterstützen Authentifizierungs Filter, unterscheiden sich jedoch geringfügig...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 2ef9e62a6c634237e920b6d7aba2127b835f959d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 03/06/2020
ms.locfileid: "78447771"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="2b464-104">Authentifizierungs Filter in ASP.net-Web-API 2</span><span class="sxs-lookup"><span data-stu-id="2b464-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="2b464-105">von [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="2b464-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="2b464-106">Ein Authentifizierungs Filter ist eine Komponente, die eine HTTP-Anforderung authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="2b464-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="2b464-107">Die Web-API 2 und MVC 5 unterstützen Authentifizierungs Filter. Sie unterscheiden sich jedoch geringfügig, größtenteils in den Benennungs Konventionen für die Filter Schnittstelle.</span><span class="sxs-lookup"><span data-stu-id="2b464-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="2b464-108">In diesem Thema werden Web-API-Authentifizierungs Filter beschrieben.</span><span class="sxs-lookup"><span data-stu-id="2b464-108">This topic describes Web API authentication filters.</span></span>

<span data-ttu-id="2b464-109">Mit Authentifizierungs filtern können Sie ein Authentifizierungsschema für einzelne Controller oder Aktionen festlegen.</span><span class="sxs-lookup"><span data-stu-id="2b464-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="2b464-110">Auf diese Weise kann Ihre APP verschiedene Authentifizierungsmechanismen für verschiedene HTTP-Ressourcen unterstützen.</span><span class="sxs-lookup"><span data-stu-id="2b464-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="2b464-111">In diesem Artikel zeige ich Code aus dem Beispiel zur Standard [Authentifizierung](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) auf [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span><span class="sxs-lookup"><span data-stu-id="2b464-111">In this article, I'll show code from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample on [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span></span> <span data-ttu-id="2b464-112">Das Beispiel zeigt einen Authentifizierungs Filter, der das HTTP-Basis Zugriffs Authentifizierungsschema (RFC 2617) implementiert.</span><span class="sxs-lookup"><span data-stu-id="2b464-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="2b464-113">Der Filter wird in einer Klasse mit dem Namen `IdentityBasicAuthenticationAttribute`implementiert.</span><span class="sxs-lookup"><span data-stu-id="2b464-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="2b464-114">Ich zeige nicht den gesamten Code aus dem Beispiel, sondern nur die Teile, die veranschaulichen, wie ein Authentifizierungs Filter geschrieben wird.</span><span class="sxs-lookup"><span data-stu-id="2b464-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="2b464-115">Festlegen eines Authentifizierungs Filters</span><span class="sxs-lookup"><span data-stu-id="2b464-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="2b464-116">Wie bei anderen Filtern können Authentifizierungs Filter pro Controller, pro Aktion oder global auf alle Web-API-Controller angewendet werden.</span><span class="sxs-lookup"><span data-stu-id="2b464-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="2b464-117">Zum Anwenden eines Authentifizierungs Filters auf einen Controller müssen Sie die Controller Klasse mit dem Filter-Attribut ergänzen.</span><span class="sxs-lookup"><span data-stu-id="2b464-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="2b464-118">Mit dem folgenden Code wird der `[IdentityBasicAuthentication]` Filter für eine Controller Klasse festgelegt, die die Standard Authentifizierung für alle Aktionen des Controllers ermöglicht.</span><span class="sxs-lookup"><span data-stu-id="2b464-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="2b464-119">Um den Filter auf eine Aktion anzuwenden, ergänzen Sie die Aktion mit dem Filter.</span><span class="sxs-lookup"><span data-stu-id="2b464-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="2b464-120">Der folgende Code legt den `[IdentityBasicAuthentication]` Filter für die `Post`-Methode des Controllers fest.</span><span class="sxs-lookup"><span data-stu-id="2b464-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="2b464-121">Wenn Sie den Filter auf alle Web-API-Controller anwenden möchten, fügen Sie ihn zu " **globalconfiguration. Filters**" hinzu.</span><span class="sxs-lookup"><span data-stu-id="2b464-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="2b464-122">Implementieren eines Web-API-Authentifizierungs Filters</span><span class="sxs-lookup"><span data-stu-id="2b464-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="2b464-123">In der Web-API implementieren Authentifizierungs Filter die [System. Web. http. Filters. iauthenticationfilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) -Schnittstelle.</span><span class="sxs-lookup"><span data-stu-id="2b464-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="2b464-124">Sie sollten auch von " **System. Attribute**" erben, damit Sie als Attribute angewendet werden können.</span><span class="sxs-lookup"><span data-stu-id="2b464-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="2b464-125">Die **iauthenticationfilter** -Schnittstelle verfügt über zwei Methoden:</span><span class="sxs-lookup"><span data-stu-id="2b464-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="2b464-126">**Authenti-easync** authentifiziert die Anforderung, indem die Anmelde Informationen in der Anforderung überprüft werden, falls vorhanden.</span><span class="sxs-lookup"><span data-stu-id="2b464-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="2b464-127">" **Herausforderer** " fügt bei Bedarf der HTTP-Antwort eine Authentifizierungs Aufforderung hinzu.</span><span class="sxs-lookup"><span data-stu-id="2b464-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="2b464-128">Diese Methoden entsprechen dem Authentifizierungs Fluss, der in [RFC 2612](http://tools.ietf.org/html/rfc2616) und [RFC 2617](http://tools.ietf.org/html/rfc2617)definiert ist:</span><span class="sxs-lookup"><span data-stu-id="2b464-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="2b464-129">Der Client sendet Anmelde Informationen im Autorisierungs Header.</span><span class="sxs-lookup"><span data-stu-id="2b464-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="2b464-130">Dies geschieht normalerweise, nachdem der Client eine Antwort vom Typ 401 (nicht autorisiert) vom Server empfangen hat.</span><span class="sxs-lookup"><span data-stu-id="2b464-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="2b464-131">Ein Client kann jedoch Anmelde Informationen mit einer beliebigen Anforderung senden, nicht nur nach dem erhalten eines 401.</span><span class="sxs-lookup"><span data-stu-id="2b464-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="2b464-132">Wenn der Server die Anmelde Informationen nicht akzeptiert, wird die Antwort 401 (nicht autorisiert) zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="2b464-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="2b464-133">Die Antwort enthält einen WWW-Authenticate-Header, der eine oder mehrere Herausforderungen enthält.</span><span class="sxs-lookup"><span data-stu-id="2b464-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="2b464-134">Jede Abfrage gibt ein Authentifizierungsschema an, das vom Server erkannt wird.</span><span class="sxs-lookup"><span data-stu-id="2b464-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="2b464-135">Der Server kann 401 auch aus einer anonymen Anforderung zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="2b464-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="2b464-136">Tatsächlich wird der Authentifizierungsprozess in der Regel initiiert:</span><span class="sxs-lookup"><span data-stu-id="2b464-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="2b464-137">Der Client sendet eine anonyme Anforderung.</span><span class="sxs-lookup"><span data-stu-id="2b464-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="2b464-138">Der Server gibt 401 zurück.</span><span class="sxs-lookup"><span data-stu-id="2b464-138">The server returns 401.</span></span>
3. <span data-ttu-id="2b464-139">Der Client sendet die Anforderung mit den Anmelde Informationen erneut.</span><span class="sxs-lookup"><span data-stu-id="2b464-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="2b464-140">Dieser Flow umfasst sowohl *Authentifizierungs* -als auch *Autorisierungs* Schritte.</span><span class="sxs-lookup"><span data-stu-id="2b464-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="2b464-141">Bei der Authentifizierung wird die Identität des Clients bestätigt.</span><span class="sxs-lookup"><span data-stu-id="2b464-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="2b464-142">Die Autorisierung bestimmt, ob der Client auf eine bestimmte Ressource zugreifen kann.</span><span class="sxs-lookup"><span data-stu-id="2b464-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="2b464-143">In der Web-API behandeln Authentifizierungs Filter die Authentifizierung, aber nicht die Autorisierung.</span><span class="sxs-lookup"><span data-stu-id="2b464-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="2b464-144">Die Autorisierung sollte durch einen Autorisierungs Filter oder innerhalb der Controller Aktion durchgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="2b464-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="2b464-145">Dies ist der Flow in der Web-API 2-Pipeline:</span><span class="sxs-lookup"><span data-stu-id="2b464-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="2b464-146">Bevor eine Aktion aufgerufen wird, erstellt die Web-API eine Liste der Authentifizierungs Filter für diese Aktion.</span><span class="sxs-lookup"><span data-stu-id="2b464-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="2b464-147">Dies schließt Filter mit Aktionsbereich, Controllerbereich und globalem Gültigkeitsbereich ein.</span><span class="sxs-lookup"><span data-stu-id="2b464-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="2b464-148">Die Web-API ruft bei jedem Filter in der Liste **Authenti-easync** auf.</span><span class="sxs-lookup"><span data-stu-id="2b464-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="2b464-149">Jeder Filter kann die Anmelde Informationen in der Anforderung überprüfen.</span><span class="sxs-lookup"><span data-stu-id="2b464-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="2b464-150">Wenn ein Filter erfolgreich Anmelde Informationen überprüft, erstellt der Filter einen **IPrincipal** und fügt ihn an die Anforderung an.</span><span class="sxs-lookup"><span data-stu-id="2b464-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="2b464-151">Ein Filter kann an dieser Stelle auch einen Fehler auslöst.</span><span class="sxs-lookup"><span data-stu-id="2b464-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="2b464-152">Wenn dies der Fall ist, wird der Rest der Pipeline nicht ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="2b464-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="2b464-153">Wenn kein Fehler auftritt, fließt die Anforderung durch den Rest der Pipeline.</span><span class="sxs-lookup"><span data-stu-id="2b464-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="2b464-154">**Zum Schluss** Ruft die Web-API die Methode "-Methode" für jeden Authentifizierungs Filter auf.</span><span class="sxs-lookup"><span data-stu-id="2b464-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="2b464-155">Filter verwenden diese Methode, um bei Bedarf der Antwort eine Aufforderung hinzuzufügen.</span><span class="sxs-lookup"><span data-stu-id="2b464-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="2b464-156">In der Regel (aber nicht immer), die als Reaktion auf einen 401-Fehler auftreten würden.</span><span class="sxs-lookup"><span data-stu-id="2b464-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="2b464-157">Die folgenden Diagramme zeigen zwei mögliche Fälle.</span><span class="sxs-lookup"><span data-stu-id="2b464-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="2b464-158">Im ersten authentifiziert der Authentifizierungs Filter die Anforderung erfolgreich, ein Autorisierungs Filter autorisiert die Anforderung, und die Controller Aktion gibt 200 (OK) zurück.</span><span class="sxs-lookup"><span data-stu-id="2b464-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="2b464-159">Im zweiten Beispiel authentifiziert der Authentifizierungs Filter die Anforderung, aber der Autorisierungs Filter gibt 401 (nicht autorisiert) zurück.</span><span class="sxs-lookup"><span data-stu-id="2b464-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="2b464-160">In diesem Fall wird die Controller Aktion nicht aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="2b464-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="2b464-161">Der Authentifizierungs Filter fügt der Antwort einen WWW-Authenticate-Header hinzu.</span><span class="sxs-lookup"><span data-stu-id="2b464-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="2b464-162">Andere Kombinationen sind möglich&mdash;z. b. wenn die Controller Aktion anonyme Anforderungen zulässt, verfügen Sie möglicherweise über einen Authentifizierungs Filter, aber keine Autorisierung.</span><span class="sxs-lookup"><span data-stu-id="2b464-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="2b464-163">Implementieren der Authenti-easync-Methode</span><span class="sxs-lookup"><span data-stu-id="2b464-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="2b464-164">Die **authentikateasync** -Methode versucht, die Anforderung zu authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="2b464-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="2b464-165">Hier die Signatur der Methode:</span><span class="sxs-lookup"><span data-stu-id="2b464-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="2b464-166">Die **Authenti-easync** -Methode muss eine der folgenden Aktionen ausführen:</span><span class="sxs-lookup"><span data-stu-id="2b464-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="2b464-167">Nothing (No-OP).</span><span class="sxs-lookup"><span data-stu-id="2b464-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="2b464-168">Erstellen Sie einen **IPrincipal** , und legen Sie ihn für die Anforderung fest.</span><span class="sxs-lookup"><span data-stu-id="2b464-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="2b464-169">Legen Sie ein Fehler Ergebnis fest.</span><span class="sxs-lookup"><span data-stu-id="2b464-169">Set an error result.</span></span>

<span data-ttu-id="2b464-170">Option (1) bedeutet, dass die Anforderung keine Anmelde Informationen enthielt, die der Filter versteht.</span><span class="sxs-lookup"><span data-stu-id="2b464-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="2b464-171">Option (2) bedeutet, dass der Filter die Anforderung erfolgreich authentifiziert hat.</span><span class="sxs-lookup"><span data-stu-id="2b464-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="2b464-172">Die Option (3) bedeutet, dass die Anforderung ungültige Anmelde Informationen enthielt (z. b. das falsche Kennwort), die eine Fehler Antwort auslösen.</span><span class="sxs-lookup"><span data-stu-id="2b464-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="2b464-173">Im folgenden finden Sie eine allgemeine Übersicht über die Implementierung von **Authenti-easync**.</span><span class="sxs-lookup"><span data-stu-id="2b464-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="2b464-174">Suchen Sie in der Anforderung nach Anmelde Informationen.</span><span class="sxs-lookup"><span data-stu-id="2b464-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="2b464-175">Wenn keine Anmelde Informationen vorhanden sind, führen Sie nichts aus, und geben Sie (No-OP) zurück.</span><span class="sxs-lookup"><span data-stu-id="2b464-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="2b464-176">Wenn Anmelde Informationen vorhanden sind, der Filter das Authentifizierungsschema aber nicht erkennt, führen Sie nichts aus, und geben Sie (No-OP) zurück.</span><span class="sxs-lookup"><span data-stu-id="2b464-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="2b464-177">Ein anderer Filter in der Pipeline kann das Schema verstehen.</span><span class="sxs-lookup"><span data-stu-id="2b464-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="2b464-178">Wenn Anmelde Informationen vorhanden sind, die der Filter versteht, versuchen Sie, diese zu authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="2b464-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="2b464-179">Wenn die Anmelde Informationen falsch sind, wird 401 zurückgegeben, indem `context.ErrorResult`festgelegt wird.</span><span class="sxs-lookup"><span data-stu-id="2b464-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="2b464-180">Wenn die Anmelde Informationen gültig sind, erstellen Sie einen **IPrincipal** , und legen Sie `context.Principal`fest.</span><span class="sxs-lookup"><span data-stu-id="2b464-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="2b464-181">Der folgende Code zeigt die **Authenti-easync** -Methode aus dem Beispiel zur Standard [Authentifizierung](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) .</span><span class="sxs-lookup"><span data-stu-id="2b464-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample.</span></span> <span data-ttu-id="2b464-182">In den Kommentaren werden die einzelnen Schritte angegeben.</span><span class="sxs-lookup"><span data-stu-id="2b464-182">The comments indicate each step.</span></span> <span data-ttu-id="2b464-183">Der Code zeigt verschiedene Arten von Fehlern: einen Autorisierungs Header ohne Anmelde Informationen, falsch formatierte Anmelde Informationen und ungültigen Benutzernamen/Kennwort.</span><span class="sxs-lookup"><span data-stu-id="2b464-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="2b464-184">Festlegen eines Fehler Ergebnisses</span><span class="sxs-lookup"><span data-stu-id="2b464-184">Setting an Error Result</span></span>

<span data-ttu-id="2b464-185">Wenn die Anmelde Informationen ungültig sind, muss der Filter `context.ErrorResult` auf ein **ihttpactionresult** festlegen, das eine Fehler Antwort erstellt.</span><span class="sxs-lookup"><span data-stu-id="2b464-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="2b464-186">Weitere Informationen zu **ihttpactionresult**finden Sie unter [Aktions Ergebnisse in der Web-API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="2b464-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="2b464-187">Das Beispiel zur Standard Authentifizierung enthält eine `AuthenticationFailureResult`-Klasse, die für diesen Zweck geeignet ist.</span><span class="sxs-lookup"><span data-stu-id="2b464-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="2b464-188">Implementieren von "".</span><span class="sxs-lookup"><span data-stu-id="2b464-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="2b464-189">Der Zweck der Methode "Delegat **Async** " besteht darin, der Antwort bei Bedarf Authentifizierungs Herausforderungen hinzuzufügen.</span><span class="sxs-lookup"><span data-stu-id="2b464-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="2b464-190">Hier die Signatur der Methode:</span><span class="sxs-lookup"><span data-stu-id="2b464-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="2b464-191">Die-Methode wird für jeden Authentifizierungs Filter in der Anforderungs Pipeline aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="2b464-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="2b464-192">Es ist wichtig zu verstehen, **dass "** " "" " " "" "" ".</span><span class="sxs-lookup"><span data-stu-id="2b464-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="2b464-193">Wenn **"** " "" "" "" "" "" **"`context.Result`,** " "" "</span><span class="sxs-lookup"><span data-stu-id="2b464-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="2b464-194">**Wenn Sie** also "" "" "" "" ".</span><span class="sxs-lookup"><span data-stu-id="2b464-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="2b464-195">Die Methode " **delegalasync** " sollte den ursprünglichen Wert `context.Result` durch ein neues **ihttpactionresult**ersetzen.</span><span class="sxs-lookup"><span data-stu-id="2b464-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="2b464-196">Dieses **ihttpactionresult** muss die ursprüngliche `context.Result`einschließen.</span><span class="sxs-lookup"><span data-stu-id="2b464-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="2b464-197">Ich rufe das ursprüngliche **ihttpactionresult** -Ergebnis im *inneren Ergebnis*und das neue **ihttpactionresult** -Ergebnis das *äußere Ergebnis*auf.</span><span class="sxs-lookup"><span data-stu-id="2b464-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="2b464-198">Das äußere Ergebnis muss folgende Aktionen ausführen:</span><span class="sxs-lookup"><span data-stu-id="2b464-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="2b464-199">Rufen Sie das innere Ergebnis auf, um die HTTP-Antwort zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="2b464-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="2b464-200">Überprüfen Sie die Antwort.</span><span class="sxs-lookup"><span data-stu-id="2b464-200">Examine the response.</span></span>
3. <span data-ttu-id="2b464-201">Fügen Sie bei Bedarf der Antwort eine Authentifizierungs Aufforderung hinzu.</span><span class="sxs-lookup"><span data-stu-id="2b464-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="2b464-202">Das folgende Beispiel stammt aus dem Beispiel zur Standard Authentifizierung.</span><span class="sxs-lookup"><span data-stu-id="2b464-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="2b464-203">Dabei wird ein **ihttpactionresult** für das äußere Ergebnis definiert.</span><span class="sxs-lookup"><span data-stu-id="2b464-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="2b464-204">Die `InnerResult`-Eigenschaft enthält das innere **ihttpactionresult**.</span><span class="sxs-lookup"><span data-stu-id="2b464-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="2b464-205">Die `Challenge`-Eigenschaft stellt einen www-Authentifizierungs Header dar.</span><span class="sxs-lookup"><span data-stu-id="2b464-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="2b464-206">Beachten Sie, dass von **ExecuteAsync** zuerst `InnerResult.ExecuteAsync` aufgerufen wird, um die HTTP-Antwort zu erstellen. Anschließend wird die Abfrage bei Bedarf hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="2b464-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="2b464-207">Überprüfen Sie den Antwort Code, bevor Sie die Abfrage hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="2b464-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="2b464-208">Die meisten Authentifizierungs Schemas fügen nur dann eine Herausforderung hinzu, wenn die Antwort 401 ist, wie hier gezeigt.</span><span class="sxs-lookup"><span data-stu-id="2b464-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="2b464-209">Einige Authentifizierungs Schemas stellen jedoch eine Herausforderung für eine Erfolgs Antwort dar.</span><span class="sxs-lookup"><span data-stu-id="2b464-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="2b464-210">Informationen hierzu finden Sie beispielsweise unter [Aushandlung](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="2b464-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="2b464-211">Wenn die `AddChallengeOnUnauthorizedResult`-Klasse angegeben wird, ist der tatsächliche **Code in "** " ""</span><span class="sxs-lookup"><span data-stu-id="2b464-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="2b464-212">Sie erstellen das Ergebnis einfach und fügen es an `context.Result`an.</span><span class="sxs-lookup"><span data-stu-id="2b464-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="2b464-213">Hinweis: das Beispiel zur Standard Authentifizierung abstrahiert diese Logik ein wenig, indem es in eine Erweiterungsmethode platziert wird.</span><span class="sxs-lookup"><span data-stu-id="2b464-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="2b464-214">Kombinieren von Authentifizierungs Filtern mit Authentifizierung auf Hostebene</span><span class="sxs-lookup"><span data-stu-id="2b464-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="2b464-215">"Authentifizierung auf Hostebene" ist die Authentifizierung, die vom Host (z. b. IIS) ausgeführt wird, bevor die Anforderung das Web-API-Framework erreicht.</span><span class="sxs-lookup"><span data-stu-id="2b464-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="2b464-216">Häufig empfiehlt es sich, die Authentifizierung auf Hostebene für den Rest der Anwendung zu aktivieren, diese aber für Ihre Web-API-Controller zu deaktivieren.</span><span class="sxs-lookup"><span data-stu-id="2b464-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="2b464-217">Ein typisches Szenario ist beispielsweise die Aktivierung der Formular Authentifizierung auf Hostebene, aber die tokenbasierte Authentifizierung für die Web-API.</span><span class="sxs-lookup"><span data-stu-id="2b464-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="2b464-218">Um die Authentifizierung auf Hostebene in der Web-API-Pipeline zu deaktivieren, wenden Sie `config.SuppressHostPrincipal()` in Ihrer Konfiguration an.</span><span class="sxs-lookup"><span data-stu-id="2b464-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="2b464-219">Dies bewirkt, dass die Web-API den **IPrincipal** aus allen Anforderungen entfernt, die in die Web-API-Pipeline eingegeben werden.</span><span class="sxs-lookup"><span data-stu-id="2b464-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="2b464-220">Effektiv &quot;&quot; der Anforderung nicht authentifiziert werden.</span><span class="sxs-lookup"><span data-stu-id="2b464-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="2b464-221">Zusätzliche Ressourcen</span><span class="sxs-lookup"><span data-stu-id="2b464-221">Additional Resources</span></span>

<span data-ttu-id="2b464-222">[ASP.net-Web-API Sicherheitsfilter](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="2b464-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
