---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Verhindern von CSRF-Angriffen (Cross-Site Request Fälschung) in ASP.NET MVC
author: MikeWasson
description: Beschreibt den CSRF-Angriff (Cross-Site Request Fälschung) und die Implementierung von Anti-CSRF-Measures in ASP.net Web MVC.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 03/06/2020
ms.locfileid: "78447111"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a><span data-ttu-id="d0b59-103">Verhindern von CSRF-Angriffen (Cross-Site Request Fälschung) in ASP.NET MVC-Anwendungen</span><span class="sxs-lookup"><span data-stu-id="d0b59-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application</span></span>

<span data-ttu-id="d0b59-104">von [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="d0b59-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="d0b59-105">Website übergreifende Anforderungs Fälschung (Cross-Site Request Fälschung, CSRF) ist ein Angriff, bei dem ein böswilliger Standort eine Anforderung an einen anfälligen Standort sendet, an dem der Benutzer zurzeit angemeldet</span><span class="sxs-lookup"><span data-stu-id="d0b59-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="d0b59-106">Im folgenden finden Sie ein Beispiel für einen CSRF-Angriff:</span><span class="sxs-lookup"><span data-stu-id="d0b59-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="d0b59-107">Ein Benutzer meldet sich mit der Formular Authentifizierung bei `www.example.com` an.</span><span class="sxs-lookup"><span data-stu-id="d0b59-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="d0b59-108">Der-Server authentifiziert den Benutzer.</span><span class="sxs-lookup"><span data-stu-id="d0b59-108">The server authenticates the user.</span></span> <span data-ttu-id="d0b59-109">Die Antwort vom Server enthält ein Authentifizierungs Cookie.</span><span class="sxs-lookup"><span data-stu-id="d0b59-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="d0b59-110">Ohne Abmeldung greift der Benutzer auf eine böswillige Website zu.</span><span class="sxs-lookup"><span data-stu-id="d0b59-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="d0b59-111">Diese böswillige Site enthält das folgende HTML-Formular:</span><span class="sxs-lookup"><span data-stu-id="d0b59-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="d0b59-112">Beachten Sie, dass das Formular Action an die anfällige Site und nicht an die böswillige Site sendet.</span><span class="sxs-lookup"><span data-stu-id="d0b59-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="d0b59-113">Dies ist der "Cross-Site"-Teil von CSRF.</span><span class="sxs-lookup"><span data-stu-id="d0b59-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="d0b59-114">Der Benutzer klickt auf die Schaltfläche Senden.</span><span class="sxs-lookup"><span data-stu-id="d0b59-114">The user clicks the submit button.</span></span> <span data-ttu-id="d0b59-115">Der Browser enthält das Authentifizierungs Cookie mit der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="d0b59-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="d0b59-116">Die Anforderung wird auf dem Server mit dem Authentifizierungs Kontext des Benutzers ausgeführt und kann alle Aktionen ausführen, die ein authentifizierter Benutzer ausführen darf.</span><span class="sxs-lookup"><span data-stu-id="d0b59-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="d0b59-117">Obwohl es für dieses Beispiel erforderlich ist, dass der Benutzer auf die Schaltfläche "Formular" klickt, kann die bösartige Seite ein Skript, das das Formular automatisch übermittelt, genauso einfach ausführen.</span><span class="sxs-lookup"><span data-stu-id="d0b59-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="d0b59-118">Außerdem wird durch die Verwendung von SSL kein CSRF-Angriff verhindert, da die böswillige Website eine "https://"-Anforderung senden kann.</span><span class="sxs-lookup"><span data-stu-id="d0b59-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="d0b59-119">In der Regel sind CSRF-Angriffe auf Websites möglich, die Cookies für die Authentifizierung verwenden, da Browser alle relevanten Cookies an die Zielwebsite senden.</span><span class="sxs-lookup"><span data-stu-id="d0b59-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="d0b59-120">Allerdings sind CSRF-Angriffe nicht auf das Ausnutzen von Cookies beschränkt.</span><span class="sxs-lookup"><span data-stu-id="d0b59-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="d0b59-121">Beispielsweise sind die Standard-und Digestauthentifizierung auch anfällig.</span><span class="sxs-lookup"><span data-stu-id="d0b59-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="d0b59-122">Nachdem sich ein Benutzer mit der Standard-oder Digestauthentifizierung anmeldet hat.</span><span class="sxs-lookup"><span data-stu-id="d0b59-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="d0b59-123">der Browser sendet die Anmelde Informationen automatisch, bis die Sitzung beendet wird.</span><span class="sxs-lookup"><span data-stu-id="d0b59-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="d0b59-124">Fälschungs Token</span><span class="sxs-lookup"><span data-stu-id="d0b59-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="d0b59-125">Um CSRF-Angriffe zu verhindern, verwendet ASP.NET MVC antifälschungstokentoken, auch als *Anforderungs Überprüfungs Token*bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="d0b59-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="d0b59-126">Der Client fordert eine HTML-Seite an, die ein Formular enthält.</span><span class="sxs-lookup"><span data-stu-id="d0b59-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="d0b59-127">Der Server enthält zwei Token in der Antwort.</span><span class="sxs-lookup"><span data-stu-id="d0b59-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="d0b59-128">Ein Token wird als Cookie gesendet.</span><span class="sxs-lookup"><span data-stu-id="d0b59-128">One token is sent as a cookie.</span></span> <span data-ttu-id="d0b59-129">Der andere wird in einem ausgeblendeten Formularfeld platziert.</span><span class="sxs-lookup"><span data-stu-id="d0b59-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="d0b59-130">Die Token werden nach dem Zufallsprinzip generiert, damit ein Angreifer die Werte nicht erraten kann.</span><span class="sxs-lookup"><span data-stu-id="d0b59-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="d0b59-131">Wenn der Client das Formular übermittelt, muss er beide Token an den Server zurücksenden.</span><span class="sxs-lookup"><span data-stu-id="d0b59-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="d0b59-132">Der Client sendet das Cookie-Token als Cookie und sendet das Formular Token innerhalb der Formulardaten.</span><span class="sxs-lookup"><span data-stu-id="d0b59-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="d0b59-133">(Ein Browser Client führt dies automatisch aus, wenn der Benutzer das Formular sendet.)</span><span class="sxs-lookup"><span data-stu-id="d0b59-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="d0b59-134">Wenn eine Anforderung nicht beide Token enthält, wird die Anforderung vom Server nicht zugelassen.</span><span class="sxs-lookup"><span data-stu-id="d0b59-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="d0b59-135">Im folgenden finden Sie ein Beispiel für ein HTML-Formular mit einem verborgenen Formular Token:</span><span class="sxs-lookup"><span data-stu-id="d0b59-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="d0b59-136">Anti-fälschungstoken funktionieren, weil die böswillige Seite die Token des Benutzers aufgrund von Richtlinien für denselben Ursprung nicht lesen kann.</span><span class="sxs-lookup"><span data-stu-id="d0b59-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="d0b59-137">(Die[gleichen Ursprungs Richtlinien](http://www.w3.org/Security/wiki/Same_Origin_Policy) verhindern, dass Dokumente, die an zwei unterschiedlichen Standorten gehostet werden, auf die Inhalte der anderen zugreifen.</span><span class="sxs-lookup"><span data-stu-id="d0b59-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="d0b59-138">Im vorherigen Beispiel kann die böswillige Seite Anforderungen an example.com senden, aber Sie kann die Antwort nicht lesen.)</span><span class="sxs-lookup"><span data-stu-id="d0b59-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="d0b59-139">Um CSRF-Angriffe zu verhindern, verwenden Sie antifälschungs Token mit einem beliebigen Authentifizierungsprotokoll, bei dem der Browser nach der Anmeldung des Benutzers automatisch Anmelde Informationen sendet.</span><span class="sxs-lookup"><span data-stu-id="d0b59-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="d0b59-140">Dies schließt cookiebasierte Authentifizierungsprotokolle ein, z. b. Formular Authentifizierung, sowie Protokolle wie die Basis-und Digestauthentifizierung.</span><span class="sxs-lookup"><span data-stu-id="d0b59-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="d0b59-141">Sie sollten antifälschungstokentoken für alle nicht sicheren Methoden (Post, Put, DELETE) benötigen.</span><span class="sxs-lookup"><span data-stu-id="d0b59-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="d0b59-142">Stellen Sie außerdem sicher, dass sichere Methoden (Get, Head) keine Nebeneffekte haben.</span><span class="sxs-lookup"><span data-stu-id="d0b59-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="d0b59-143">Wenn Sie die Domänen übergreifende Unterstützung (z. b. cors oder JSONP) aktivieren, sind sogar sichere Methoden wie Get potenziell anfällig für CSRF-Angriffe, sodass der Angreifer potenziell sensible Daten lesen kann.</span><span class="sxs-lookup"><span data-stu-id="d0b59-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="d0b59-144">Anti-fälschungstokentoken in ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="d0b59-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="d0b59-145">Verwenden Sie die Hilfsmethode **htmlhelper. antiforgerytoken** , um die antifälschungstoken zu einer Razor Page hinzuzufügen:</span><span class="sxs-lookup"><span data-stu-id="d0b59-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="d0b59-146">Diese Methode fügt das ausgeblendete Formularfeld hinzu und legt auch das Cookie-Token fest.</span><span class="sxs-lookup"><span data-stu-id="d0b59-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="d0b59-147">Anti-CSRF und AJAX</span><span class="sxs-lookup"><span data-stu-id="d0b59-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="d0b59-148">Das Formulartoken kann für AJAX-Anforderungen ein Problem darstellen, da eine AJAX-Anforderung unter Umständen JSON-Daten und keine HTML-Formulardaten sendet.</span><span class="sxs-lookup"><span data-stu-id="d0b59-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="d0b59-149">Eine Lösung besteht darin, die Token in einem benutzerdefinierten HTTP-Header zu senden.</span><span class="sxs-lookup"><span data-stu-id="d0b59-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="d0b59-150">Im folgenden Code wird Razor-Syntax zum Generieren der Token verwendet, und anschließend werden die Token einer AJAX-Anforderung hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="d0b59-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="d0b59-151">Die Token werden auf dem Server generiert, indem **Antifälschung. getTokens**aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="d0b59-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="d0b59-152">Extrahieren Sie die Token beim Verarbeiten der Anforderung aus dem Anforderungsheader.</span><span class="sxs-lookup"><span data-stu-id="d0b59-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="d0b59-153">Anschließend wird die **Antifälschung. Validate** -Methode aufgerufen, um die Token zu validieren.</span><span class="sxs-lookup"><span data-stu-id="d0b59-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="d0b59-154">Die **Validate** -Methode löst eine Ausnahme aus, wenn die Token nicht gültig sind.</span><span class="sxs-lookup"><span data-stu-id="d0b59-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
