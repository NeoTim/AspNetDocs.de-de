---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: Umpacken von Daten Bank Änderungen innerhalbC#einer Transaktion () | Microsoft-Dokumentation
author: rick-anderson
description: Dieses Tutorial ist das erste von vier, das das Aktualisieren, löschen und Einfügen von Daten Batches untersucht. In diesem Tutorial erfahren Sie, wie Datenbanktransaktionen zulassen...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: da69e466a5b506b869dc8fc0624f3e6a479199a8
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 11/28/2019
ms.locfileid: "74624748"
---
# <a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="a454a-104">Umschließen von Datenbankänderungen innerhalb einer Transaktion (C#)</span><span class="sxs-lookup"><span data-stu-id="a454a-104">Wrapping Database Modifications within a Transaction (C#)</span></span>

<span data-ttu-id="a454a-105">von [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="a454a-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="a454a-106">[Code herunterladen](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) oder [PDF herunterladen](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="a454a-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="a454a-107">Dieses Tutorial ist das erste von vier, das das Aktualisieren, löschen und Einfügen von Daten Batches untersucht.</span><span class="sxs-lookup"><span data-stu-id="a454a-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="a454a-108">In diesem Tutorial erfahren Sie, wie Datenbanktransaktionen Batch Änderungen als atomarer Vorgang ausführen können, wodurch sichergestellt wird, dass entweder alle Schritte erfolgreich sind oder alle Schritte fehlschlagen.</span><span class="sxs-lookup"><span data-stu-id="a454a-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>

## <a name="introduction"></a><span data-ttu-id="a454a-109">Einführung</span><span class="sxs-lookup"><span data-stu-id="a454a-109">Introduction</span></span>

<span data-ttu-id="a454a-110">Wie bereits im Tutorial zum [Einfügen, aktualisieren und Löschen von Daten](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) erläutert wurde, bietet die GridView integrierte Unterstützung für das Bearbeiten und löschen auf Zeilenebene.</span><span class="sxs-lookup"><span data-stu-id="a454a-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="a454a-111">Mit wenigen Mausklicks ist es möglich, eine umfangreiche Daten Änderungs Schnittstelle zu erstellen, ohne eine Codezeile schreiben zu müssen, solange Sie Inhalt mit Bearbeitung und Löschung auf Zeilen Basis haben.</span><span class="sxs-lookup"><span data-stu-id="a454a-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="a454a-112">In bestimmten Szenarien reicht dies jedoch nicht aus, und wir müssen Benutzern die Möglichkeit geben, einen Batch von Datensätzen zu bearbeiten oder zu löschen.</span><span class="sxs-lookup"><span data-stu-id="a454a-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="a454a-113">Die meisten webbasierten e-Mail-Clients verwenden z. b. ein Raster, um jede Nachricht aufzulisten, wobei jede Zeile ein Kontrollkästchen zusammen mit den e-Mail-Informationen (Betreff, Absender usw.) enthält.</span><span class="sxs-lookup"><span data-stu-id="a454a-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="a454a-114">Diese Schnittstelle ermöglicht dem Benutzer das Löschen mehrerer Nachrichten durch überprüfen und anschließendes Klicken auf die Schaltfläche ausgewählte Meldungen löschen.</span><span class="sxs-lookup"><span data-stu-id="a454a-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="a454a-115">Eine Schnittstelle für die Batch Bearbeitung ist ideal für Situationen, in denen Benutzer häufig viele verschiedene Datensätze bearbeiten.</span><span class="sxs-lookup"><span data-stu-id="a454a-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="a454a-116">Anstatt zu erzwingen, dass der Benutzer auf Bearbeiten klickt, nehmen Sie die Änderung vor, und klicken Sie dann für jeden Datensatz, der geändert werden muss, eine Batch Bearbeitungs Schnittstelle, die jede Zeile mit der Bearbeitungs Schnittstelle rendert.</span><span class="sxs-lookup"><span data-stu-id="a454a-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="a454a-117">Der Benutzer kann schnell den Satz von Zeilen ändern, der geändert werden muss, und dann diese Änderungen speichern, indem er auf die Schaltfläche Alle aktualisieren klickt.</span><span class="sxs-lookup"><span data-stu-id="a454a-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="a454a-118">In diesen Tutorials erfahren Sie, wie Sie Schnittstellen zum Einfügen, bearbeiten und Löschen von Daten Batches erstellen.</span><span class="sxs-lookup"><span data-stu-id="a454a-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="a454a-119">Beim Ausführen von Batch Vorgängen ist es wichtig zu bestimmen, ob es möglich ist, dass einige der Vorgänge im Batch erfolgreich sind, während andere fehlschlagen.</span><span class="sxs-lookup"><span data-stu-id="a454a-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="a454a-120">Stellen Sie sich eine Schnittstelle zum Löschen von Batches vor: Was geschieht, wenn der erste ausgewählte Datensatz erfolgreich gelöscht wurde, aber der zweite fehlschlägt, beispielsweise aufgrund einer Verletzung der FOREIGN KEY-Einschränkung?</span><span class="sxs-lookup"><span data-stu-id="a454a-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="a454a-121">Soll für den ersten Datensatz ein Rollback ausgeführt werden, oder ist es akzeptabel, dass der erste Datensatz gelöscht wird?</span><span class="sxs-lookup"><span data-stu-id="a454a-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="a454a-122">Wenn der Batch Vorgang als [atomarer Vorgang](http://en.wikipedia.org/wiki/Atomic_operation)behandelt werden soll, bei dem entweder alle Schritte erfolgreich sind oder alle Schritte fehlschlagen, muss die Datenzugriffs Ebene erweitert werden, um Unterstützung für [Datenbanktransaktionen](http://en.wikipedia.org/wiki/Database_transaction)zu bieten.</span><span class="sxs-lookup"><span data-stu-id="a454a-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="a454a-123">Datenbanktransaktionen garantieren eine Atomizität für den Satz von `INSERT`-, `UPDATE`-und `DELETE` Anweisungen, die im Rahmen der Transaktion ausgeführt werden, und sind eine Funktion, die von den meisten modernen Datenbanksystemen unterstützt wird.</span><span class="sxs-lookup"><span data-stu-id="a454a-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="a454a-124">In diesem Tutorial wird erläutert, wie Sie die DAL für die Verwendung von Datenbanktransaktionen erweitern.</span><span class="sxs-lookup"><span data-stu-id="a454a-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="a454a-125">In den nachfolgenden Tutorials wird die Implementierung von Webseiten für das Einfügen, aktualisieren und Löschen von Schnittstellen untersucht.</span><span class="sxs-lookup"><span data-stu-id="a454a-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="a454a-126">Legen Sie Los!</span><span class="sxs-lookup"><span data-stu-id="a454a-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="a454a-127">Wenn Sie Daten in einer Batch Transaktion ändern, ist Atomizität nicht immer erforderlich.</span><span class="sxs-lookup"><span data-stu-id="a454a-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="a454a-128">In einigen Szenarien ist es möglicherweise akzeptabel, dass einige Datenänderungen erfolgreich sind und andere im gleichen Batch fehlschlagen, z. b. beim Löschen eines Satzes von e-Mails von einem webbasierten e-Mail-Client.</span><span class="sxs-lookup"><span data-stu-id="a454a-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="a454a-129">Wenn ein Datenbankfehler in der Mitte des Löschvorgangs aufgetreten ist, ist es wahrscheinlich akzeptabel, dass diese Datensätze, die ohne Fehler verarbeitet werden, gelöscht werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="a454a-130">In solchen Fällen muss die DAL nicht geändert werden, um Datenbanktransaktionen zu unterstützen.</span><span class="sxs-lookup"><span data-stu-id="a454a-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="a454a-131">Es gibt jedoch noch andere Batch Vorgangs Szenarios, in denen Atomizität von entscheidender Bedeutung ist.</span><span class="sxs-lookup"><span data-stu-id="a454a-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="a454a-132">Wenn ein Kunde ihren Betrag von einem Bankkonto in ein anderes Konto verschiebt, müssen zwei Vorgänge ausgeführt werden: die Beträge müssen vom ersten Konto abgezogen und dann der zweiten hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="a454a-133">Obwohl die Bank keine Meinung hat, dass der erste Schritt erfolgreich war, der zweite Schritt jedoch fehlschlägt, sind die Kunden verständlicherweise verärgert.</span><span class="sxs-lookup"><span data-stu-id="a454a-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="a454a-134">Ich empfehle Ihnen, dieses Tutorial zu durcharbeiten und die Erweiterungen der dal zu implementieren, um Datenbanktransaktionen zu unterstützen, auch wenn Sie nicht beabsichtigen, Sie in den folgenden drei Tutorials zu verwenden: einfügen, aktualisieren und Löschen von Schnittstellen.</span><span class="sxs-lookup"><span data-stu-id="a454a-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>

## <a name="an-overview-of-transactions"></a><span data-ttu-id="a454a-135">Eine Übersicht über Transaktionen</span><span class="sxs-lookup"><span data-stu-id="a454a-135">An Overview of Transactions</span></span>

<span data-ttu-id="a454a-136">Die meisten Datenbanken unterstützen *Transaktionen*, die es ermöglichen, mehrere Daten Bank Befehle in einer einzelnen logischen Arbeitseinheit zu gruppieren.</span><span class="sxs-lookup"><span data-stu-id="a454a-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="a454a-137">Die Daten Bank Befehle, aus denen eine Transaktion besteht, sind garantiert atomarisch, was bedeutet, dass entweder alle Befehle fehlschlagen oder alle erfolgreich ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="a454a-138">Im Allgemeinen werden Transaktionen mithilfe von SQL-Anweisungen in folgendem Muster implementiert:</span><span class="sxs-lookup"><span data-stu-id="a454a-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="a454a-139">Geben Sie den Start einer Transaktion an.</span><span class="sxs-lookup"><span data-stu-id="a454a-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="a454a-140">Führen Sie die SQL-Anweisungen aus, die die Transaktion umfassen.</span><span class="sxs-lookup"><span data-stu-id="a454a-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="a454a-141">Wenn in einer der Anweisungen aus Schritt 2 ein Fehler auftritt, führen Sie ein Rollback für die Transaktion aus.</span><span class="sxs-lookup"><span data-stu-id="a454a-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="a454a-142">Wenn alle Anweisungen aus Schritt 2 ohne Fehler abgeschlossen werden, führen Sie einen Commit für die Transaktion aus.</span><span class="sxs-lookup"><span data-stu-id="a454a-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="a454a-143">Die SQL-Anweisungen, die zum Erstellen, Ausführen eines Commits und Rollbacks der Transaktion verwendet werden, können beim Schreiben von SQL-Skripts oder bei der Erstellung gespeicherter Prozeduren manuell eingegeben werden. Sie können auch Programm gesteuert mithilfe von ADO.net oder den Klassen im [`System.Transactions` Namespace](https://msdn.microsoft.com/library/system.transactions.aspx)</span><span class="sxs-lookup"><span data-stu-id="a454a-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="a454a-144">In diesem Tutorial untersuchen wir nur die Verwaltung von Transaktionen mithilfe von ADO.net.</span><span class="sxs-lookup"><span data-stu-id="a454a-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="a454a-145">In einem zukünftigen Tutorial wird erläutert, wie gespeicherte Prozeduren in der Datenzugriffs Ebene verwendet werden. zu diesem Zeitpunkt werden die SQL-Anweisungen zum Erstellen, Rollback und Commit von Transaktionen untersucht.</span><span class="sxs-lookup"><span data-stu-id="a454a-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="a454a-146">Weitere Informationen finden Sie in der Zwischenzeit unter [Verwalten von Transaktionen in SQL Server gespeicherten Prozeduren](http://www.4guysfromrolla.com/webtech/080305-1.shtml) .</span><span class="sxs-lookup"><span data-stu-id="a454a-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="a454a-147">Die [`TransactionScope`-Klasse](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) im `System.Transactions`-Namespace ermöglicht Entwicklern, eine Reihe von Anweisungen innerhalb des Bereichs einer Transaktion Programm gesteuert zu umschließen, und bietet Unterstützung für komplexe Transaktionen, die mehrere Quellen umfassen, z. b. zwei verschiedene Datenbanken oder sogar heterogene Typen von Daten speichern, wie z. b. eine Microsoft SQL Server Datenbank, eine Oracle-Datenbank und ein Webdienst.</span><span class="sxs-lookup"><span data-stu-id="a454a-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="a454a-148">Ich entschied mich für die Verwendung von ADO.NET-Transaktionen für dieses Tutorial anstelle der `TransactionScope`-Klasse, da ADO.net spezifischer für Datenbanktransaktionen ist und in vielen Fällen weitaus weniger ressourcenintensiv ist.</span><span class="sxs-lookup"><span data-stu-id="a454a-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="a454a-149">Außerdem verwendet die `TransactionScope`-Klasse in bestimmten Szenarien die Microsoft-Distributed Transaction Coordinator (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="a454a-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="a454a-150">Die Konfigurations-, Implementierungs-und Leistungsprobleme im Zusammenhang mit MSDTC machen es zu einem Recht spezialisierten und fortgeschrittenen Thema, das über den Rahmen dieser Tutorials hinausgeht.</span><span class="sxs-lookup"><span data-stu-id="a454a-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>

<span data-ttu-id="a454a-151">Beim Arbeiten mit dem SqlClient-Anbieter in ADO.net werden Transaktionen durch einen-aufrufbefehl der [`SqlConnection`-Klasse](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) [`BeginTransaction`-Methode](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx)initiiert, die ein`SqlTransaction`- [Objekt](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx)zurückgibt.</span><span class="sxs-lookup"><span data-stu-id="a454a-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="a454a-152">Die Daten Änderungs Anweisungen, mit denen die Transaktion zusammengesetzt wird, werden in einem `try...catch`-Block platziert.</span><span class="sxs-lookup"><span data-stu-id="a454a-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="a454a-153">Wenn ein Fehler in einer Anweisung im `try`-Block auftritt, wird die Ausführung an den `catch` Block übertragen, in dem für die Transaktion über die [`Rollback`-Methode](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx)des `SqlTransaction`-Objekts ein Rollback ausgeführt werden kann.</span><span class="sxs-lookup"><span data-stu-id="a454a-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="a454a-154">Wenn alle-Anweisungen erfolgreich abgeschlossen werden, führt ein aufrufungs Vorgang des `SqlTransaction` Objekt s [`Commit` Methode](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) am Ende des `try` Blocks einen Commit für die Transaktion aus.</span><span class="sxs-lookup"><span data-stu-id="a454a-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="a454a-155">Der folgende Code Ausschnitt veranschaulicht dieses Muster.</span><span class="sxs-lookup"><span data-stu-id="a454a-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="a454a-156">Weitere Syntax und Beispiele für die Verwendung von Transaktionen mit ADO.net finden Sie unter Verwalten der [Daten Bank Konsistenz mit Transaktionen](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) .</span><span class="sxs-lookup"><span data-stu-id="a454a-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="a454a-157">Standardmäßig verwenden die TableAdapters in einem typisierten DataSet keine Transaktionen.</span><span class="sxs-lookup"><span data-stu-id="a454a-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="a454a-158">Um Unterstützung für Transaktionen bereitzustellen, müssen wir die TableAdapter-Klassen erweitern, um zusätzliche Methoden aufzunehmen, die das oben beschriebene Muster verwenden, um eine Reihe von Daten Änderungs Anweisungen innerhalb des Gültigkeits Bereichs einer Transaktion auszuführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="a454a-159">In Schritt 2 erfahren Sie, wie Sie mit partiellen Klassen diese Methoden hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="a454a-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="a454a-160">Schritt 1: Erstellen der Webseiten für das Arbeiten mit Batch Daten</span><span class="sxs-lookup"><span data-stu-id="a454a-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="a454a-161">Bevor wir uns mit der Erweiterung der dal zur Unterstützung von Datenbanktransaktionen beschäftigen, nehmen Sie sich zunächst einen Moment Zeit, um die ASP.NET-Webseiten zu erstellen, die wir für dieses Tutorial benötigen, und die drei folgenden.</span><span class="sxs-lookup"><span data-stu-id="a454a-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="a454a-162">Fügen Sie zunächst einen neuen Ordner mit dem Namen `BatchData` hinzu, und fügen Sie dann die folgenden ASP.NET Seiten hinzu, wobei Sie jede Seite der `Site.master` Master Seite zuordnen.</span><span class="sxs-lookup"><span data-stu-id="a454a-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`

![Fügen Sie die ASP.NET-Seiten für die SqlDataSource-bezogenen Tutorials hinzu.](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="a454a-164">**Abbildung 1**: Hinzufügen der ASP.NET-Seiten für die auf SqlDataSource bezogenen Tutorials</span><span class="sxs-lookup"><span data-stu-id="a454a-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>

<span data-ttu-id="a454a-165">Wie bei den anderen Ordnern verwendet `Default.aspx` das `SectionLevelTutorialListing.ascx` Benutzer Steuerelement, um die Lernprogramme in diesem Abschnitt aufzulisten.</span><span class="sxs-lookup"><span data-stu-id="a454a-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="a454a-166">Fügen Sie dieses Benutzer Steuerelement daher `Default.aspx` hinzu, indem Sie es aus dem Projektmappen-Explorer auf die Seite s Designansicht ziehen.</span><span class="sxs-lookup"><span data-stu-id="a454a-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>

<span data-ttu-id="a454a-167">[![das Benutzer Steuerelement "sectionleveltutoriallisting. ascx" zu "default. aspx" hinzufügen](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="a454a-168">**Abbildung 2**: Hinzufügen des `SectionLevelTutorialListing.ascx` Benutzer Steuer Elements zu `Default.aspx` ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>

<span data-ttu-id="a454a-169">Fügen Sie schließlich diese vier Seiten als Einträge zur `Web.sitemap` Datei hinzu.</span><span class="sxs-lookup"><span data-stu-id="a454a-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="a454a-170">Fügen Sie insbesondere nach dem Anpassen der Site Map-`<siteMapNode>`das folgende Markup hinzu:</span><span class="sxs-lookup"><span data-stu-id="a454a-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>

[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="a454a-171">Nehmen Sie sich nach dem Aktualisieren `Web.sitemap`einen Moment Zeit, um die Tutorials-Website über einen Browser anzuzeigen.</span><span class="sxs-lookup"><span data-stu-id="a454a-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="a454a-172">Das Menü auf der linken Seite enthält jetzt Elemente für die Tutorials arbeiten mit Daten im Batch Modus.</span><span class="sxs-lookup"><span data-stu-id="a454a-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>

![Die Site Übersicht enthält jetzt Einträge für Lernprogramme zum Arbeiten mit Daten in Batch Verarbeitung.](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="a454a-174">**Abbildung 3**: die Site Übersicht enthält jetzt Einträge für Lernprogramme zum Arbeiten mit Daten im Batch Modus.</span><span class="sxs-lookup"><span data-stu-id="a454a-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>

## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="a454a-175">Schritt 2: Aktualisieren der Datenzugriffs Ebene zur Unterstützung von Datenbanktransaktionen</span><span class="sxs-lookup"><span data-stu-id="a454a-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="a454a-176">Wie bereits im ersten Tutorial, dem [Erstellen einer Datenzugriffs Ebene](../introduction/creating-a-data-access-layer-cs.md), erläutert, besteht das typisierte DataSet in unserer dal aus DataTables und TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="a454a-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="a454a-177">Die DataTables enthalten Daten, während die TableAdapters die Funktionalität zum Lesen von Daten aus der Datenbank in die DataTables bereitstellen, um die Datenbank mit an den DataTables vorgenommenen Änderungen zu aktualisieren, usw.</span><span class="sxs-lookup"><span data-stu-id="a454a-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="a454a-178">Beachten Sie, dass die TableAdapters zwei Muster zum Aktualisieren von Daten bereitstellen, die als Batch Update und DB-Direct bezeichnet werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="a454a-179">Beim Batch Aktualisierungs Muster wird dem TableAdapter ein DataSet, eine Datentabelle oder eine Auflistung von DataRows übermittelt.</span><span class="sxs-lookup"><span data-stu-id="a454a-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="a454a-180">Diese Daten werden aufgelistet und für jede eingefügte, geänderte oder gelöschte Zeile, die `InsertCommand`, die `UpdateCommand`oder die `DeleteCommand` ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="a454a-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="a454a-181">Beim DB-Direct-Muster werden dem TableAdapter stattdessen die Werte der Spalten, die zum Einfügen, aktualisieren oder Löschen eines einzelnen Datensatzes erforderlich sind, übermittelt.</span><span class="sxs-lookup"><span data-stu-id="a454a-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="a454a-182">Die direkte Daten Bank Muster Methode verwendet dann diese über gebenden Werte, um die entsprechende `InsertCommand`, `UpdateCommand`oder `DeleteCommand` Anweisung auszuführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="a454a-183">Unabhängig vom verwendeten Aktualisierungs Muster werden von den automatisch generierten TableAdapters-Methoden keine Transaktionen verwendet.</span><span class="sxs-lookup"><span data-stu-id="a454a-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="a454a-184">Standardmäßig wird jede vom TableAdapter ausgeführte INSERT-, Update-oder DELETE-Operation als einzelner einzelner Vorgang behandelt.</span><span class="sxs-lookup"><span data-stu-id="a454a-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="a454a-185">Stellen Sie sich beispielsweise vor, dass das DB-Direct-Muster von Code in der BLL verwendet wird, um zehn Datensätze in die Datenbank einzufügen.</span><span class="sxs-lookup"><span data-stu-id="a454a-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="a454a-186">Mit diesem Code wird die TableAdapter s-`Insert`-Methode zehnmal aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="a454a-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="a454a-187">Wenn die ersten fünf Einfügungen erfolgreich sind, aber der sechste Vorgang zu einer Ausnahme geführt hat, verbleiben die ersten fünf eingefügten Datensätze in der Datenbank.</span><span class="sxs-lookup"><span data-stu-id="a454a-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="a454a-188">Analog gilt: Wenn das Batch Aktualisierungs Muster verwendet wird, um eingefügte, geänderte und gelöschte Zeilen in einer Datentabelle einzufügen, zu aktualisieren und zu löschen, wenn die ersten einzelnen Änderungen erfolgreich waren, aber eine spätere Änderung einen Fehler festgestellt hat, werden diese früheren Änderungen durchgeführt. abgeschlossen würde in der Datenbank verbleiben.</span><span class="sxs-lookup"><span data-stu-id="a454a-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="a454a-189">In bestimmten Szenarien möchten wir eine Atomizität über eine Reihe von Änderungen hinweg sicherstellen.</span><span class="sxs-lookup"><span data-stu-id="a454a-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="a454a-190">Um dies zu erreichen, müssen Sie den TableAdapter manuell erweitern, indem Sie neue Methoden hinzufügen, die die `InsertCommand`, `UpdateCommand`und `DeleteCommand` en unter dem Rahmen einer Transaktion ausführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="a454a-191">Beim [Erstellen einer Datenzugriffs Ebene](../introduction/creating-a-data-access-layer-cs.md) haben wir uns mit der Verwendung von [partiellen Klassen](http://en.wikipedia.org/wiki/Partial_type) beschäftigt, um die Funktionalität der DataTables im typisierten DataSet zu erweitern.</span><span class="sxs-lookup"><span data-stu-id="a454a-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="a454a-192">Diese Technik kann auch mit TableAdapters verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="a454a-193">Das typisierte DataSet `Northwind.xsd` befindet sich im Ordner "`App_Code`" `DAL` Unterordner "".</span><span class="sxs-lookup"><span data-stu-id="a454a-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="a454a-194">Erstellen Sie im Ordner "`DAL`" einen Unterordner mit dem Namen `TransactionSupport`, und fügen Sie eine neue Klassendatei mit dem Namen `ProductsTableAdapter.TransactionSupport.cs` hinzu (siehe Abbildung 4).</span><span class="sxs-lookup"><span data-stu-id="a454a-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="a454a-195">Diese Datei enthält die partielle Implementierung der `ProductsTableAdapter`, die Methoden zum Ausführen von Datenänderungen mithilfe einer Transaktion enthält.</span><span class="sxs-lookup"><span data-stu-id="a454a-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>

![Fügen Sie einen Ordner mit dem Namen Transaktionsunterstützung und eine Klassendatei namens ProductsTableAdapter.TransactionSupport.cs hinzu.](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="a454a-197">**Abbildung 4**: Hinzufügen eines Ordners namens `TransactionSupport` und einer Klassendatei mit dem Namen `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="a454a-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>

<span data-ttu-id="a454a-198">Geben Sie in der `ProductsTableAdapter.TransactionSupport.cs`-Datei den folgenden Code ein:</span><span class="sxs-lookup"><span data-stu-id="a454a-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="a454a-199">Das `partial`-Schlüsselwort in der Klassen Deklaration gibt dem Compiler an, dass die Elemente, die in hinzugefügt wurden, der `ProductsTableAdapter`-Klasse im `NorthwindTableAdapters`-Namespace hinzugefügt werden sollen.</span><span class="sxs-lookup"><span data-stu-id="a454a-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="a454a-200">Notieren Sie sich die `using System.Data.SqlClient`-Anweisung am Anfang der Datei.</span><span class="sxs-lookup"><span data-stu-id="a454a-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="a454a-201">Da der TableAdapter so konfiguriert wurde, dass er den SqlClient-Anbieter verwendet, wird intern ein [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) Objekt verwendet, um seine Befehle an die Datenbank auszugeben.</span><span class="sxs-lookup"><span data-stu-id="a454a-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="a454a-202">Folglich müssen wir die `SqlTransaction`-Klasse verwenden, um die Transaktion zu starten und anschließend einen Commit für die Transaktion auszuführen oder einen Rollback auszuführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="a454a-203">Wenn Sie einen anderen Datenspeicher als Microsoft SQL Server verwenden, müssen Sie den entsprechenden Anbieter verwenden.</span><span class="sxs-lookup"><span data-stu-id="a454a-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="a454a-204">Diese Methoden stellen die Bausteine bereit, die zum Starten, Rollback und Commit einer Transaktion erforderlich sind.</span><span class="sxs-lookup"><span data-stu-id="a454a-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="a454a-205">Sie sind als `public`gekennzeichnet und ermöglichen die Verwendung innerhalb der `ProductsTableAdapter`, von einer anderen Klasse in der dal oder von einer anderen Ebene in der Architektur, wie z. b. der BLL.</span><span class="sxs-lookup"><span data-stu-id="a454a-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="a454a-206">`BeginTransaction` öffnet die interne `SqlConnection` TableAdapter s (falls erforderlich), beginnt die Transaktion und weist Sie der `Transaction`-Eigenschaft zu und fügt die Transaktion den internen `SqlDataAdapter` s `SqlCommand` Objekten an.</span><span class="sxs-lookup"><span data-stu-id="a454a-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="a454a-207">`CommitTransaction` und `RollbackTransaction` vor dem Schließen des internen `Rollback` Objekts die `Commit`-und `Connection` Methoden des `Transaction`-Objekts aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="a454a-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="a454a-208">Schritt 3: Hinzufügen von Methoden zum Aktualisieren und Löschen von Daten im Rahmen einer Transaktion</span><span class="sxs-lookup"><span data-stu-id="a454a-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="a454a-209">Wenn diese Methoden abgeschlossen sind, können Sie `ProductsDataTable` oder der BLL, die eine Reihe von Befehlen ausführen, eine Reihe von Befehlen hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="a454a-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="a454a-210">Die folgende Methode verwendet das Batch Aktualisierungs Muster, um eine `ProductsDataTable` Instanz mithilfe einer Transaktion zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="a454a-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="a454a-211">Eine Transaktion wird gestartet, indem die `BeginTransaction`-Methode aufgerufen und dann ein `try...catch`-Block verwendet wird, um die Daten Änderungs Anweisungen auszugeben.</span><span class="sxs-lookup"><span data-stu-id="a454a-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="a454a-212">Wenn der aufzurufende `Adapter` `Update` Methode eine Ausnahme auslöst, wird die Ausführung an den `catch` Block übertragen, in dem für die Transaktion ein Rollback ausgeführt wird und die Ausnahme erneut ausgelöst wird.</span><span class="sxs-lookup"><span data-stu-id="a454a-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="a454a-213">Erinnern Sie sich daran, dass die `Update`-Methode das Batch Aktualisierungs Muster implementiert, indem Sie die Zeilen der angegebenen `ProductsDataTable` auflisten und die erforderlichen `InsertCommand`, `UpdateCommand`und `DeleteCommand` s ausführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="a454a-214">Wenn einer dieser Befehle zu einem Fehler führt, wird für die Transaktion ein Rollback ausgeführt, und die vorherigen Änderungen, die während der Lebensdauer der Transaktion vorgenommen wurden, werden rückgängig gemacht.</span><span class="sxs-lookup"><span data-stu-id="a454a-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="a454a-215">Wenn die `Update`-Anweisung ohne Fehler abgeschlossen wird, wird die Transaktion vollständig committet.</span><span class="sxs-lookup"><span data-stu-id="a454a-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="a454a-216">Fügen Sie die `UpdateWithTransaction`-Methode über die partielle Klasse in `ProductsTableAdapter.TransactionSupport.cs`der `ProductsTableAdapter`-Klasse hinzu.</span><span class="sxs-lookup"><span data-stu-id="a454a-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="a454a-217">Alternativ kann diese Methode der Business Logic Layer s `ProductsBLL`-Klasse mit einigen geringfügigen syntaktischen Änderungen hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="a454a-218">Das Schlüsselwort this in `this.BeginTransaction()`, `this.CommitTransaction()`und `this.RollbackTransaction()` muss also durch `Adapter` ersetzt werden (denken Sie daran, dass `Adapter` der Name einer Eigenschaft in `ProductsBLL` vom Typ `ProductsTableAdapter`ist).</span><span class="sxs-lookup"><span data-stu-id="a454a-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="a454a-219">Die `UpdateWithTransaction`-Methode verwendet das Batch Aktualisierungs Muster, aber eine Reihe von DB-Direct-aufrufen kann auch innerhalb des Gültigkeits Bereichs einer Transaktion verwendet werden, wie die folgende Methode zeigt.</span><span class="sxs-lookup"><span data-stu-id="a454a-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="a454a-220">Die `DeleteProductsWithTransaction`-Methode akzeptiert als Eingabe eine `List<T>` vom Typ `int`, bei der es sich um die `ProductID` s handelt, die gelöscht werden sollen.</span><span class="sxs-lookup"><span data-stu-id="a454a-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="a454a-221">Die-Methode initiiert die Transaktion über einen Aufruf von `BeginTransaction` und durchläuft dann im `try`-Block die angegebene Liste, die das DB-Direct-Muster `Delete`-Methode für jeden `ProductID` Wert aufruft.</span><span class="sxs-lookup"><span data-stu-id="a454a-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="a454a-222">Wenn einer der Aufrufe von `Delete` fehlschlägt, wird die Steuerung an den `catch` Block übertragen, in dem für die Transaktion ein Rollback ausgeführt wird und die Ausnahme erneut ausgelöst wird.</span><span class="sxs-lookup"><span data-stu-id="a454a-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="a454a-223">Wenn alle Aufrufe von `Delete` erfolgreich sind, wird für die Transaktion ein Commit ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="a454a-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="a454a-224">Fügen Sie der `ProductsBLL`-Klasse diese Methode hinzu.</span><span class="sxs-lookup"><span data-stu-id="a454a-224">Add this method to the `ProductsBLL` class.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="a454a-225">Anwenden von Transaktionen auf mehrere TableAdapters</span><span class="sxs-lookup"><span data-stu-id="a454a-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="a454a-226">Der in diesem Tutorial untersuchte Transaktionscode ermöglicht, dass mehrere Anweisungen für die `ProductsTableAdapter` als atomarer Vorgang behandelt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="a454a-227">Aber was geschieht, wenn mehrere Änderungen an unterschiedlichen Datenbanktabellen atomarisch ausgeführt werden müssen?</span><span class="sxs-lookup"><span data-stu-id="a454a-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="a454a-228">Wenn Sie beispielsweise eine Kategorie löschen, möchten wir möglicherweise zuerst die aktuellen Produkte einer anderen Kategorie zuweisen.</span><span class="sxs-lookup"><span data-stu-id="a454a-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="a454a-229">Diese beiden Schritte zum erneuten Zuweisen der Produkte und zum Löschen der Kategorie sollten als atomarer Vorgang ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="a454a-230">Die `ProductsTableAdapter` enthält jedoch nur Methoden zum Ändern der `Products` Tabelle, und die `CategoriesTableAdapter` enthält nur Methoden zum Ändern der `Categories` Tabelle.</span><span class="sxs-lookup"><span data-stu-id="a454a-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="a454a-231">Wie kann eine Transaktion also beide TableAdapters umfassen?</span><span class="sxs-lookup"><span data-stu-id="a454a-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="a454a-232">Eine Möglichkeit ist das Hinzufügen einer Methode zum `CategoriesTableAdapter` mit dem Namen `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` und die Methode dazu, eine gespeicherte Prozedur aufzurufen, die die Produkte neu zuweist und die Kategorie innerhalb des Gültigkeits Bereichs einer Transaktion löscht, die in der gespeicherten Prozedur definiert ist.</span><span class="sxs-lookup"><span data-stu-id="a454a-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="a454a-233">In einem zukünftigen Tutorial wird erläutert, wie Transaktionen in gespeicherten Prozeduren gestartet, übernommen und zurückgesetzt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="a454a-234">Eine andere Möglichkeit besteht darin, eine Hilfsklasse in der dal zu erstellen, die die `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` Methode enthält.</span><span class="sxs-lookup"><span data-stu-id="a454a-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="a454a-235">Diese Methode erstellt eine Instanz des `CategoriesTableAdapter` und des `ProductsTableAdapter` und legt diese beiden TableAdapters `Connection` Eigenschaften auf dieselbe `SqlConnection` Instanz fest.</span><span class="sxs-lookup"><span data-stu-id="a454a-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="a454a-236">An diesem Punkt initiiert entweder einer der beiden TableAdapters die Transaktion mit einem `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="a454a-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="a454a-237">Die TableAdapters-Methoden zum erneuten Zuweisen der Produkte und zum Löschen der Kategorie werden in einem `try...catch` Block mit der Transaktion, für die ein Commit oder ein Rollback ausgeführt wurde, aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="a454a-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="a454a-238">Schritt 4: Hinzufügen der`UpdateWithTransaction`Methode zur Geschäftslogik Schicht</span><span class="sxs-lookup"><span data-stu-id="a454a-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="a454a-239">In Schritt 3 haben wir der `ProductsTableAdapter` in der dal eine `UpdateWithTransaction` Methode hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="a454a-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="a454a-240">Wir sollten der BLL eine entsprechende Methode hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="a454a-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="a454a-241">Obwohl die Darstellungs Schicht direkt zur dal aufrufen kann, um die `UpdateWithTransaction`-Methode aufzurufen, haben diese Tutorials eine mehrschichtige Architektur definiert, die die DAL von der Präsentationsschicht isoliert.</span><span class="sxs-lookup"><span data-stu-id="a454a-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="a454a-242">Daher wird dieser Ansatz durch ihn fortgesetzt.</span><span class="sxs-lookup"><span data-stu-id="a454a-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="a454a-243">Öffnen Sie die Datei `ProductsBLL`-Klasse, und fügen Sie eine Methode mit dem Namen `UpdateWithTransaction` hinzu, die einfach die entsprechende dal-Methode aufruft.</span><span class="sxs-lookup"><span data-stu-id="a454a-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="a454a-244">In `ProductsBLL`gibt es nun zwei neue Methoden: `UpdateWithTransaction`, die Sie soeben hinzugefügt haben, und `DeleteProductsWithTransaction`, das in Schritt 3 hinzugefügt wurde.</span><span class="sxs-lookup"><span data-stu-id="a454a-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="a454a-245">Diese Methoden schließen nicht das `DataObjectMethodAttribute`-Attribut ein, das den meisten anderen Methoden in der `ProductsBLL`-Klasse zugewiesen ist, da wir diese Methoden direkt aus den ASP.net Pages-Code-Behind-Klassen aufrufen.</span><span class="sxs-lookup"><span data-stu-id="a454a-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="a454a-246">Beachten Sie, dass `DataObjectMethodAttribute` verwendet wird, um die Methoden zu markieren, die im Assistenten zum Konfigurieren von Datenquellen von ObjectDataSource und auf der Registerkarte (auswählen, aktualisieren, einfügen oder löschen) angezeigt werden sollen.</span><span class="sxs-lookup"><span data-stu-id="a454a-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="a454a-247">Da in der GridView keine integrierte Unterstützung für das Bearbeiten oder Löschen von Batches vorhanden ist, müssen diese Methoden Programm gesteuert aufgerufen werden, anstatt den Code losen deklarativen Ansatz zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="a454a-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>

## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="a454a-248">Schritt 5: atomisch Aktualisieren von Datenbankdaten von der Darstellungs Schicht</span><span class="sxs-lookup"><span data-stu-id="a454a-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="a454a-249">Um die Auswirkung zu veranschaulichen, die die Transaktion beim Aktualisieren eines Daten Satz Batches hat, können Sie eine Benutzeroberfläche erstellen, die alle Produkte in einer GridView auflistet und ein Schaltflächen-websteuer Element enthält, das, wenn Sie darauf klicken, die Produkte `CategoryID` Werte neu zuweist.</span><span class="sxs-lookup"><span data-stu-id="a454a-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="a454a-250">Insbesondere wird die Neuzuweisung der Kategorie fortgesetzt, sodass den ersten mehreren Produkten ein gültiger `CategoryID` Wert zugewiesen wird, während anderen Personen gezielt ein nicht vorhandener `CategoryID` Wert zugewiesen wird.</span><span class="sxs-lookup"><span data-stu-id="a454a-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="a454a-251">Wenn Sie versuchen, die Datenbank mit einem Produkt zu aktualisieren, dessen `CategoryID` nicht mit der `CategoryID`einer vorhandenen Kategorie identisch ist, tritt eine Verletzung der Fremdschlüssel Einschränkung auf, und es wird eine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="a454a-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="a454a-252">In diesem Beispiel werden wir sehen, dass bei der Verwendung einer Transaktion die von der Foreign Key-Einschränkungs Verletzung ausgelöste Ausnahme dazu führt, dass die vorherigen gültigen `CategoryID` Änderungen zurückgesetzt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="a454a-253">Wenn Sie jedoch keine Transaktion verwenden, bleiben die Änderungen an den ursprünglichen Kategorien erhalten.</span><span class="sxs-lookup"><span data-stu-id="a454a-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="a454a-254">Öffnen Sie zunächst die Seite `Transactions.aspx` im Ordner `BatchData`, und ziehen Sie eine GridView aus der Toolbox auf den Designer.</span><span class="sxs-lookup"><span data-stu-id="a454a-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="a454a-255">Legen Sie den `ID` auf `Products`, und binden Sie ihn aus dem Smarttag an eine neue ObjectDataSource mit dem Namen `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a454a-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="a454a-256">Konfigurieren Sie ObjectDataSource so, dass die Daten aus der `ProductsBLL` Klasse `GetProducts` Methode abgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="a454a-257">Dabei handelt es sich um eine schreibgeschützte GridView. Legen Sie daher die Dropdown Listen auf den Registerkarten aktualisieren, einfügen und löschen auf (keine) fest, und klicken Sie auf Fertigstellen.</span><span class="sxs-lookup"><span data-stu-id="a454a-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>

<span data-ttu-id="a454a-258">[![Abbildung 5: Konfigurieren von ObjectDataSource für die Verwendung der GetProducts-Methode der productbll-Klasse](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="a454a-259">**Abbildung 5**: Abbildung 5: Konfigurieren von ObjectDataSource für die Verwendung der `ProductsBLL` Class s `GetProducts`-Methode ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>

<span data-ttu-id="a454a-260">[![die Dropdown Listen auf den Registerkarten aktualisieren, einfügen und löschen auf (keine) festgelegt.](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="a454a-261">**Abbildung 6**: Festlegen der Dropdown Listen auf den Registerkarten "Aktualisieren", "Einfügen" und "Löschen" auf "(keine)" ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>

<span data-ttu-id="a454a-262">Nach dem Abschließen des Assistenten zum Konfigurieren von Datenquellen erstellt Visual Studio boundfields und ein CheckBoxField für die Product Data-Felder.</span><span class="sxs-lookup"><span data-stu-id="a454a-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="a454a-263">Entfernen Sie alle diese Felder außer `ProductID`, `ProductName`, `CategoryID`und `CategoryName`, und benennen Sie `ProductName` Eigenschaften `CategoryName` und `HeaderText` boundfields in Product bzw. Category um.</span><span class="sxs-lookup"><span data-stu-id="a454a-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="a454a-264">Aktivieren Sie im Smarttags die Option Paging aktivieren.</span><span class="sxs-lookup"><span data-stu-id="a454a-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="a454a-265">Nachdem Sie diese Änderungen vorgenommen haben, sollten das deklarative Markup der GridView-und ObjectDataSource-Datei wie folgt aussehen:</span><span class="sxs-lookup"><span data-stu-id="a454a-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="a454a-266">Fügen Sie als nächstes drei Schaltflächen-websteuer Elemente oberhalb der GridView hinzu.</span><span class="sxs-lookup"><span data-stu-id="a454a-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="a454a-267">Legen Sie die Text-Eigenschaft der ersten Schaltfläche auf Aktualisierungs Raster, die zweiten s zum Ändern von Kategorien (mit Transaction) und die dritte zum Ändern von Kategorien (ohne Transaktion) fest.</span><span class="sxs-lookup"><span data-stu-id="a454a-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="a454a-268">An diesem Punkt sollte das Designansicht in Visual Studio ähnlich dem Screenshot in Abbildung 7 aussehen.</span><span class="sxs-lookup"><span data-stu-id="a454a-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>

<span data-ttu-id="a454a-269">[![die Seite eine GridView-und drei Button-websteuer Elemente enthält.](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="a454a-270">**Abbildung 7**: die Seite enthält ein GridView-Steuerelement und drei Schaltflächen-websteuer Elemente ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>

<span data-ttu-id="a454a-271">Erstellen Sie Ereignishandler für jede der drei Schaltflächen `Click` Ereignisse, und verwenden Sie den folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="a454a-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>

[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="a454a-272">Die Schaltfläche "Aktualisieren" `Click` Ereignis Handlers bindet die Daten einfach an die GridView weiter, indem Sie die `Products` GridView s `DataBind`-Methode aufrufen.</span><span class="sxs-lookup"><span data-stu-id="a454a-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="a454a-273">Der zweite Ereignishandler weist die Produkte `CategoryID` en neu zu und verwendet die neue Transaktions Methode aus der BLL, um die Datenbankaktualisierungen unter dem Rahmen einer Transaktion auszuführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="a454a-274">Beachten Sie, dass jedes Produkt s `CategoryID` willkürlich auf denselben Wert wie die `ProductID`festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="a454a-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="a454a-275">Dies funktioniert gut für die ersten Produkte, da diese Produkte `ProductID` Werte aufweisen, die den gültigen `CategoryID` en zugeordnet werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="a454a-276">Wenn die `ProductID` s jedoch zu groß werden, wird diese zufällige Überschneidung von `ProductID` s und `CategoryID` s nicht mehr angewendet.</span><span class="sxs-lookup"><span data-stu-id="a454a-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="a454a-277">Der dritte `Click`-Ereignishandler aktualisiert die Produkte `CategoryID` s auf die gleiche Weise, sendet das Update jedoch mithilfe der Standard `Update`-Methode der `ProductsTableAdapter` s an die Datenbank.</span><span class="sxs-lookup"><span data-stu-id="a454a-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="a454a-278">Diese `Update` Methode umschließt nicht die Reihe von Befehlen in einer Transaktion, sodass diese Änderungen vor dem ersten gefundenen Fremdschlüssel-Einschränkungs Fehler beibehalten werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="a454a-279">Um dieses Verhalten zu veranschaulichen, besuchen Sie diese Seite über einen Browser.</span><span class="sxs-lookup"><span data-stu-id="a454a-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="a454a-280">Zunächst sollten Sie die erste Seite mit den Daten sehen, wie in Abbildung 8 dargestellt.</span><span class="sxs-lookup"><span data-stu-id="a454a-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="a454a-281">Klicken Sie anschließend auf die Schaltfläche Kategorien ändern (mit Transaktion).</span><span class="sxs-lookup"><span data-stu-id="a454a-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="a454a-282">Dies führt zu einem Postback und versucht, alle Produkte `CategoryID` Werte zu aktualisieren, führt jedoch zu einer Verletzung der Fremdschlüssel Einschränkung (siehe Abbildung 9).</span><span class="sxs-lookup"><span data-stu-id="a454a-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>

<span data-ttu-id="a454a-283">[![die Produkte in einer kostenpflichtigen GridView angezeigt werden.](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="a454a-284">**Abbildung 8**: die Produkte werden in einer kostenpflichtigen GridView angezeigt ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>

<span data-ttu-id="a454a-285">[![erneute Zuweisung der Kategorien führt zu einer Verletzung der Fremdschlüssel Einschränkung.](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="a454a-286">**Abbildung 9**: Neuzuweisen der Kategorien führt zu einer Verletzung der Fremdschlüssel Einschränkung ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>

<span data-ttu-id="a454a-287">Klicken Sie nun auf die Schaltfläche zurück, und klicken Sie dann auf die Schaltfläche Raster aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="a454a-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="a454a-288">Beim Aktualisieren der Daten sollte genau dieselbe Ausgabe wie in Abbildung 8 dargestellt angezeigt werden.</span><span class="sxs-lookup"><span data-stu-id="a454a-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="a454a-289">Das heißt, obwohl einige der Produkte `CategoryID` s in zulässige Werte geändert und in der Datenbank aktualisiert wurden, wurde ein Rollback ausgeführt, als die Foreign Key-Einschränkungs Verletzung aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="a454a-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="a454a-290">Klicken Sie jetzt auf die Schaltfläche Kategorien ändern (ohne Transaktion).</span><span class="sxs-lookup"><span data-stu-id="a454a-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="a454a-291">Dies führt zu dem gleichen Verstoß gegen den Fremdschlüssel Einschränkungs Verstoß (siehe Abbildung 9), aber diesmal werden die Produkte, deren `CategoryID` Werte in einen gültigen Wert geändert wurden, nicht zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="a454a-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="a454a-292">Klicken Sie auf die Schaltfläche zurück, und klicken Sie dann auf die Schaltfläche Raster aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="a454a-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="a454a-293">Wie in Abbildung 10 gezeigt, wurden die `CategoryID` s der ersten acht Produkte neu zugewiesen.</span><span class="sxs-lookup"><span data-stu-id="a454a-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="a454a-294">In Abbildung 8 hatte chanz. b. einen `CategoryID` von 1, aber in Abbildung 10 wurde er zu 2 neu zugewiesen.</span><span class="sxs-lookup"><span data-stu-id="a454a-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>

<span data-ttu-id="a454a-295">[![die CategoryID-Werte einiger Produkte aktualisiert wurden, während andere nicht](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="a454a-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="a454a-296">**Abbildung 10**: einige Produkte `CategoryID` Werte wurden aktualisiert, während andere nicht waren ([Klicken Sie, um das Bild in voller Größe anzuzeigen](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="a454a-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>

## <a name="summary"></a><span data-ttu-id="a454a-297">Summary</span><span class="sxs-lookup"><span data-stu-id="a454a-297">Summary</span></span>

<span data-ttu-id="a454a-298">Standardmäßig wrappen die TableAdapter s-Methoden nicht die ausgeführten Daten Bank Anweisungen innerhalb des Bereichs einer Transaktion, aber mit wenigen Aufgaben können wir Methoden hinzufügen, die eine Transaktion erstellen, Committe und zurücksetzen.</span><span class="sxs-lookup"><span data-stu-id="a454a-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="a454a-299">In diesem Tutorial haben wir drei Methoden in der `ProductsTableAdapter`-Klasse erstellt: `BeginTransaction`, `CommitTransaction`und `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="a454a-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="a454a-300">Wir haben gesehen, wie diese Methoden zusammen mit einem `try...catch`-Block verwendet werden, um eine Reihe von Daten Änderungs Anweisungen atomarisch zu machen.</span><span class="sxs-lookup"><span data-stu-id="a454a-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="a454a-301">Insbesondere haben wir die `UpdateWithTransaction` Methode in der `ProductsTableAdapter`erstellt, die das Batch Aktualisierungs Muster verwendet, um die erforderlichen Änderungen an den Zeilen eines angegebenen `ProductsDataTable`auszuführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="a454a-302">Wir haben auch die `DeleteProductsWithTransaction`-Methode zur `ProductsBLL`-Klasse in der BLL hinzugefügt, die eine `List` von `ProductID` Werten als Eingabe akzeptiert und die DB-Direct Pattern-Methode `Delete` für jede `ProductID`aufruft.</span><span class="sxs-lookup"><span data-stu-id="a454a-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="a454a-303">Beide Methoden beginnen, indem Sie eine Transaktion erstellen und dann die Daten Änderungs Anweisungen in einem `try...catch`-Block ausführen.</span><span class="sxs-lookup"><span data-stu-id="a454a-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="a454a-304">Wenn eine Ausnahme auftritt, wird ein Rollback für die Transaktion ausgeführt; andernfalls wird ein Commit ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="a454a-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="a454a-305">In Schritt 5 wurden die Auswirkungen von transaktionalen Batch Updates im Vergleich zu Batch Updates veranschaulicht, die die Verwendung einer Transaktion vernachlässigt haben.</span><span class="sxs-lookup"><span data-stu-id="a454a-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="a454a-306">In den nächsten drei Tutorials bauen wir auf der Grundlage in diesem Tutorial auf und erstellen Benutzeroberflächen zum Ausführen von Batch Aktualisierungen, Löschungen und Einfügungen.</span><span class="sxs-lookup"><span data-stu-id="a454a-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="a454a-307">Fröhliche Programmierung!</span><span class="sxs-lookup"><span data-stu-id="a454a-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="a454a-308">Weiterführende Themen</span><span class="sxs-lookup"><span data-stu-id="a454a-308">Further Reading</span></span>

<span data-ttu-id="a454a-309">Weitere Informationen zu den in diesem Tutorial behandelten Themen finden Sie in den folgenden Ressourcen:</span><span class="sxs-lookup"><span data-stu-id="a454a-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="a454a-310">Beibehalten der Daten Bank Konsistenz mit Transaktionen</span><span class="sxs-lookup"><span data-stu-id="a454a-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="a454a-311">Verwalten von Transaktionen in SQL Server gespeicherten Prozeduren</span><span class="sxs-lookup"><span data-stu-id="a454a-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="a454a-312">Einfache Transaktionen: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="a454a-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="a454a-313">Transaktionscope und DataAdapters</span><span class="sxs-lookup"><span data-stu-id="a454a-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="a454a-314">Verwenden von Oracle Database Transaktionen in .net</span><span class="sxs-lookup"><span data-stu-id="a454a-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="a454a-315">Informationen zum Autor</span><span class="sxs-lookup"><span data-stu-id="a454a-315">About the Author</span></span>

<span data-ttu-id="a454a-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), Autor der sieben ASP/ASP. net-Bücher und Gründer von [4GuysFromRolla.com](http://www.4guysfromrolla.com), hat seit 1998 mit Microsoft-Webtechnologien gearbeitet.</span><span class="sxs-lookup"><span data-stu-id="a454a-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="a454a-317">Scott arbeitet als unabhängiger Berater, Ausbilder und Writer.</span><span class="sxs-lookup"><span data-stu-id="a454a-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="a454a-318">Sein letztes Buch ist [*Sams Teach Yourself ASP.NET 2,0 in 24 Stunden*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="a454a-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="a454a-319">Er kann übermitchell@4GuysFromRolla.comerreicht werden [.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="a454a-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="a454a-320">oder über seinen Blog finden Sie unter [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="a454a-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="a454a-321">Besonders vielen Dank</span><span class="sxs-lookup"><span data-stu-id="a454a-321">Special Thanks To</span></span>

<span data-ttu-id="a454a-322">Diese tutorialreihe wurde von vielen hilfreichen Reviewern geprüft.</span><span class="sxs-lookup"><span data-stu-id="a454a-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="a454a-323">Die führenden Reviewer für dieses Tutorial waren Dave Gardner, Hilton giesanow und Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="a454a-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="a454a-324">Möchten Sie meine bevorstehenden MSDN-Artikel überprüfen?</span><span class="sxs-lookup"><span data-stu-id="a454a-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="a454a-325">Wenn dies der Fall ist, können Sie eine Zeile in [mitchell@4GuysFromRolla.comablegen.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="a454a-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="a454a-326">Nächste</span><span class="sxs-lookup"><span data-stu-id="a454a-326">Next</span></span>](batch-updating-cs.md)
