---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Mit dem Entity Framework 4,0 und dem ObjectDataSource-Steuerelement, Teil 2: Hinzufügen einer Geschäftslogik Schicht und Komponenten Tests | Microsoft-Dokumentation'
author: tdykstra
description: Diese tutorialreihe basiert auf der Webanwendung der Website von "Web", die in der tutorialreihe für die ersten Schritte mit Entity Framework 4,0 erstellt wurde. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 24344cc33d7c26d7c408db26c0530ef2c708a7d3
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 03/06/2020
ms.locfileid: "78439953"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="757b8-104">Mit dem Entity Framework 4,0 und dem ObjectDataSource-Steuerelement, Teil 2: Hinzufügen einer Geschäftslogik Schicht und Komponenten Tests</span><span class="sxs-lookup"><span data-stu-id="757b8-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>

<span data-ttu-id="757b8-105">von [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="757b8-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="757b8-106">Diese tutorialreihe basiert auf der Webanwendung der Website von "Web", die in der tutorialreihe für die ersten Schritte [mit Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="757b8-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="757b8-107">Wenn Sie die vorherigen Tutorials nicht durchgearbeitet haben, können Sie die Anwendung, die Sie erstellt haben, als Ausgangspunkt für dieses Tutorial [herunterladen](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) .</span><span class="sxs-lookup"><span data-stu-id="757b8-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="757b8-108">Sie können auch [die Anwendung herunterladen](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , die von der kompletten tutorialreihe erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="757b8-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="757b8-109">Wenn Sie Fragen zu den Tutorials haben, können Sie Sie im ASP.net- [Entity Framework Forum](https://forums.asp.net/1227.aspx)Posten.</span><span class="sxs-lookup"><span data-stu-id="757b8-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="757b8-110">Im vorherigen Tutorial haben Sie eine n-Tier-Webanwendung mit dem-Entity Framework und dem `ObjectDataSource`-Steuerelement erstellt.</span><span class="sxs-lookup"><span data-stu-id="757b8-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="757b8-111">In diesem Tutorial wird gezeigt, wie Geschäftslogik hinzugefügt wird, während die Geschäftslogik Schicht (Business Logic Layer, BLL) und die Datenzugriffs Schicht (Data-Access Layer, DAL) getrennt bleiben. Außerdem wird gezeigt, wie automatisierte Komponententests für die BLL erstellt werden.</span><span class="sxs-lookup"><span data-stu-id="757b8-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="757b8-112">In diesem Tutorial führen Sie die folgenden Aufgaben aus:</span><span class="sxs-lookup"><span data-stu-id="757b8-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="757b8-113">Erstellen Sie eine Repository-Schnittstelle, die die benötigten Datenzugriffs Methoden deklariert.</span><span class="sxs-lookup"><span data-stu-id="757b8-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="757b8-114">Implementieren Sie die Repository-Schnittstelle in der Repository-Klasse.</span><span class="sxs-lookup"><span data-stu-id="757b8-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="757b8-115">Erstellen Sie eine Geschäftslogik Klasse, die die Repository-Klasse aufruft, um Datenzugriffs Funktionen auszuführen.</span><span class="sxs-lookup"><span data-stu-id="757b8-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="757b8-116">Verbinden Sie das `ObjectDataSource`-Steuerelement mit der Geschäftslogik Klasse anstelle der Repository-Klasse.</span><span class="sxs-lookup"><span data-stu-id="757b8-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="757b8-117">Erstellen Sie ein Komponenten Testprojekt und eine Repository-Klasse, die in-Memory-Auflistungen für Ihren Datenspeicher verwendet.</span><span class="sxs-lookup"><span data-stu-id="757b8-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="757b8-118">Erstellen Sie einen Komponenten Test für Geschäftslogik, den Sie der Geschäftslogik Klasse hinzufügen möchten, und führen Sie dann den Test aus, und sehen Sie, dass er fehlschlägt.</span><span class="sxs-lookup"><span data-stu-id="757b8-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="757b8-119">Implementieren Sie die Geschäftslogik in der Geschäftslogik Klasse, führen Sie den Komponenten Test erneut aus, und überprüfen Sie den Komponenten Test.</span><span class="sxs-lookup"><span data-stu-id="757b8-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="757b8-120">Sie arbeiten mit den Seiten " *Departments. aspx* " und " *departmentsadd. aspx* ", die Sie im vorherigen Tutorial erstellt haben.</span><span class="sxs-lookup"><span data-stu-id="757b8-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="757b8-121">Erstellen einer Repository-Schnittstelle</span><span class="sxs-lookup"><span data-stu-id="757b8-121">Creating a Repository Interface</span></span>

<span data-ttu-id="757b8-122">Zunächst erstellen Sie die Repository-Schnittstelle.</span><span class="sxs-lookup"><span data-stu-id="757b8-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="757b8-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="757b8-124">Erstellen Sie im Ordner *dal* eine neue Klassendatei, nennen Sie Sie *ISchoolRepository.cs*, und ersetzen Sie den vorhandenen Code durch den folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="757b8-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="757b8-125">Die-Schnittstelle definiert eine Methode für jede der CRUD (Create, Read, Update, DELETE)-Methoden, die Sie in der Repository-Klasse erstellt haben.</span><span class="sxs-lookup"><span data-stu-id="757b8-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="757b8-126">Geben Sie in der `SchoolRepository`-Klasse in *SchoolRepository.cs*an, dass diese Klasse die `ISchoolRepository`-Schnittstelle implementiert:</span><span class="sxs-lookup"><span data-stu-id="757b8-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="757b8-127">Erstellen einer Geschäftslogik Klasse</span><span class="sxs-lookup"><span data-stu-id="757b8-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="757b8-128">Als Nächstes erstellen Sie die Geschäftslogik Klasse.</span><span class="sxs-lookup"><span data-stu-id="757b8-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="757b8-129">Dies geschieht, damit Sie Geschäftslogik hinzufügen können, die vom `ObjectDataSource`-Steuerelement ausgeführt wird, obwohl dies noch nicht der Fall ist.</span><span class="sxs-lookup"><span data-stu-id="757b8-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="757b8-130">Derzeit führt die neue Geschäftslogik Klasse nur die gleichen CRUD-Vorgänge aus, die das Repository ausführt.</span><span class="sxs-lookup"><span data-stu-id="757b8-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="757b8-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="757b8-132">Erstellen Sie einen neuen Ordner, und benennen Sie ihn mit *BLL*.</span><span class="sxs-lookup"><span data-stu-id="757b8-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="757b8-133">(In einer realen Anwendung würde die Geschäftslogik Schicht in der Regel als Klassenbibliothek implementiert werden – ein separates Projekt – aber um dieses Tutorial einfach zu halten, werden BLL-Klassen in einem Projektordner aufbewahrt.)</span><span class="sxs-lookup"><span data-stu-id="757b8-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="757b8-134">Erstellen Sie im Ordner *BLL* eine neue Klassendatei, nennen Sie Sie *SchoolBL.cs*, und ersetzen Sie den vorhandenen Code durch den folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="757b8-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="757b8-135">Mit diesem Code werden die gleichen CRUD-Methoden erstellt, die Sie zuvor in der Repository-Klasse gesehen haben. anstatt direkt auf die Entity Framework Methoden zuzugreifen, werden die Methoden der Repository-Klasse aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="757b8-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="757b8-136">Die Klassen Variable, die einen Verweis auf die Repository-Klasse enthält, wird als Schnittstellentyp definiert, und der Code, der die Repository-Klasse instanziiert, ist in zwei Konstruktoren enthalten.</span><span class="sxs-lookup"><span data-stu-id="757b8-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="757b8-137">Der Parameter lose Konstruktor wird vom `ObjectDataSource`-Steuerelement verwendet.</span><span class="sxs-lookup"><span data-stu-id="757b8-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="757b8-138">Es wird eine Instanz der `SchoolRepository`-Klasse erstellt, die Sie zuvor erstellt haben.</span><span class="sxs-lookup"><span data-stu-id="757b8-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="757b8-139">Der andere Konstruktor ermöglicht den Code, der die Geschäftslogik Klasse instanziiert, an jedes Objekt, das die Repository-Schnittstelle implementiert.</span><span class="sxs-lookup"><span data-stu-id="757b8-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="757b8-140">Die CRUD-Methoden, mit denen die Repository-Klasse und die beiden Konstruktoren aufgerufen werden, ermöglichen die Verwendung der Geschäftslogik Klasse mit jedem beliebigen Back-End-Datenspeicher, den Sie auswählen.</span><span class="sxs-lookup"><span data-stu-id="757b8-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="757b8-141">Die Geschäftslogik Klasse muss nicht wissen, wie die von ihr aufrufende Klasse die Daten persistent speichert.</span><span class="sxs-lookup"><span data-stu-id="757b8-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="757b8-142">(Dies wird häufig als *Persistenzignoranz*bezeichnet.) Dies vereinfacht Komponententests, da Sie die Business-Logic-Klasse mit einer Repository-Implementierung verbinden können, die etwas so einfaches wie in-Memory-`List` Sammlungen zum Speichern von Daten verwendet.</span><span class="sxs-lookup"><span data-stu-id="757b8-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="757b8-143">Technisch gesehen sind die Entitäts Objekte nach wie vor keine Persistenz, da Sie von Klassen instanziiert werden, die von der `EntityObject` Klasse des Entity Framework erben.</span><span class="sxs-lookup"><span data-stu-id="757b8-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="757b8-144">Um die Unkenntnis der Persistenz zu gewährleisten, können Sie *einfache alte CLR-Objekte*oder *POCOS*anstelle von Objekten verwenden, die von der `EntityObject`-Klasse erben.</span><span class="sxs-lookup"><span data-stu-id="757b8-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="757b8-145">Die Verwendung von POCOS geht über den Rahmen dieses Tutorials hinaus.</span><span class="sxs-lookup"><span data-stu-id="757b8-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="757b8-146">Weitere Informationen finden Sie auf der MSDN-Website unter [Testability und Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx) .)</span><span class="sxs-lookup"><span data-stu-id="757b8-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>

<span data-ttu-id="757b8-147">Nun können Sie die `ObjectDataSource`-Steuerelemente mit der Geschäftslogik Klasse verbinden, anstatt Sie mit dem Repository zu verbinden und zu überprüfen, ob alles wie zuvor funktioniert.</span><span class="sxs-lookup"><span data-stu-id="757b8-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="757b8-148">Ändern Sie in " *Departments. aspx* " und " *departmentsadd. aspx*" jedes Vorkommen von `TypeName="ContosoUniversity.DAL.SchoolRepository"` in "`TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="757b8-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="757b8-149">(Es sind insgesamt vier Instanzen vorhanden.)</span><span class="sxs-lookup"><span data-stu-id="757b8-149">(There are four instances in all.)</span></span>

<span data-ttu-id="757b8-150">Führen Sie die Seiten " *Departments. aspx* " und " *departmentsadd. aspx* " aus, um zu überprüfen, ob Sie weiterhin wie zuvor funktionieren.</span><span class="sxs-lookup"><span data-stu-id="757b8-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="757b8-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="757b8-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="757b8-153">Erstellen eines Komponenten Test Projekts und einer Repository-Implementierung</span><span class="sxs-lookup"><span data-stu-id="757b8-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="757b8-154">Fügen Sie der Projekt Mappe mithilfe der Vorlage **Test Projekt** ein neues Projekt hinzu, und benennen Sie es `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="757b8-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="757b8-155">Fügen Sie im Testprojekt einen Verweis auf `System.Data.Entity` hinzu, und fügen Sie dem Projekt `ContosoUniversity` einen Projekt Verweis hinzu.</span><span class="sxs-lookup"><span data-stu-id="757b8-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="757b8-156">Sie können jetzt die Repository-Klasse erstellen, die Sie mit Komponententests verwenden werden.</span><span class="sxs-lookup"><span data-stu-id="757b8-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="757b8-157">Der Datenspeicher für dieses Repository ist innerhalb der-Klasse.</span><span class="sxs-lookup"><span data-stu-id="757b8-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="757b8-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="757b8-159">Erstellen Sie im Testprojekt eine neue Klassendatei, nennen Sie Sie *MockSchoolRepository.cs*, und ersetzen Sie den vorhandenen Code durch den folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="757b8-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="757b8-160">Diese Repository-Klasse verfügt über die gleichen CRUD-Methoden wie die, die direkt auf die Entity Framework zugreift, aber Sie funktioniert mit `List` Auflistungen im Arbeitsspeicher und nicht mit einer-Datenbank.</span><span class="sxs-lookup"><span data-stu-id="757b8-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="757b8-161">Dies erleichtert es einer Testklasse, Komponententests für die Geschäftslogik Klasse einzurichten und zu validieren.</span><span class="sxs-lookup"><span data-stu-id="757b8-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="757b8-162">Erstellen von Komponenten Tests</span><span class="sxs-lookup"><span data-stu-id="757b8-162">Creating Unit Tests</span></span>

<span data-ttu-id="757b8-163">Die **Test** Projektvorlage hat eine Stubkomponenten Test-Klasse für Sie erstellt, und die nächste Aufgabe besteht darin, diese Klasse zu ändern, indem Sie Komponenten Testmethoden für die Geschäftslogik hinzufügt, die Sie der Geschäftslogik Klasse hinzufügen möchten.</span><span class="sxs-lookup"><span data-stu-id="757b8-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="757b8-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="757b8-165">Bei der IT-Abteilung von "IT" können alle einzelnen Dozenten nur Administrator einer einzelnen Abteilung sein, und Sie müssen Geschäftslogik hinzufügen, um diese Regel zu erzwingen.</span><span class="sxs-lookup"><span data-stu-id="757b8-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="757b8-166">Sie beginnen mit dem Hinzufügen von Tests und Ausführen der Tests, um zu sehen, dass Sie fehlschlagen.</span><span class="sxs-lookup"><span data-stu-id="757b8-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="757b8-167">Fügen Sie dann den Code hinzu, und führen Sie die Tests erneut aus, und erwarten Sie, dass Sie erfolgreich sind.</span><span class="sxs-lookup"><span data-stu-id="757b8-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="757b8-168">Öffnen Sie die Datei *UnitTest1.cs* , und fügen Sie `using`-Anweisungen für die Geschäftslogik und die Datenzugriffsebenen hinzu, die Sie im Projekt contosouniversity erstellt haben:</span><span class="sxs-lookup"><span data-stu-id="757b8-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="757b8-169">Ersetzen Sie die `TestMethod1`-Methode durch die folgenden Methoden:</span><span class="sxs-lookup"><span data-stu-id="757b8-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="757b8-170">Die `CreateSchoolBL`-Methode erstellt eine Instanz der Repository-Klasse, die Sie für das Komponenten Testprojekt erstellt haben, die dann an eine neue Instanz der Business-Logic-Klasse weitergeleitet wird.</span><span class="sxs-lookup"><span data-stu-id="757b8-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="757b8-171">Die-Methode verwendet dann die Business-Logic-Klasse, um drei Abteilungen einzufügen, die Sie in Testmethoden verwenden können.</span><span class="sxs-lookup"><span data-stu-id="757b8-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="757b8-172">Die Testmethoden überprüfen, ob die Geschäftslogik Klasse eine Ausnahme auslöst, wenn jemand versucht, eine neue Abteilung mit demselben Administrator wie eine vorhandene Abteilung einzufügen, oder wenn jemand versucht, den Administrator einer Abteilung zu aktualisieren, indem er auf die ID einer Person festgelegt wird. der, der bereits Administrator einer anderen Abteilung ist.</span><span class="sxs-lookup"><span data-stu-id="757b8-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="757b8-173">Sie haben noch keine Ausnahme Klasse erstellt, daher wird dieser Code nicht kompiliert.</span><span class="sxs-lookup"><span data-stu-id="757b8-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="757b8-174">Um die Kompilierung zu kompilieren, klicken Sie mit der rechten Maustaste auf `DuplicateAdministratorException`, und wählen Sie **generieren**und dann **Klasse**aus.</span><span class="sxs-lookup"><span data-stu-id="757b8-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="757b8-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="757b8-176">Dadurch wird im Testprojekt eine Klasse erstellt, die Sie nach dem Erstellen der Ausnahme Klasse im Hauptprojekt löschen können.</span><span class="sxs-lookup"><span data-stu-id="757b8-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="757b8-177">und die Geschäftslogik implementiert.</span><span class="sxs-lookup"><span data-stu-id="757b8-177">and implemented the business logic.</span></span>

<span data-ttu-id="757b8-178">Führen Sie das Testprojekt aus.</span><span class="sxs-lookup"><span data-stu-id="757b8-178">Run the test project.</span></span> <span data-ttu-id="757b8-179">Erwartungsgemäß schlägt der Test fehl.</span><span class="sxs-lookup"><span data-stu-id="757b8-179">As expected, the tests fail.</span></span>

<span data-ttu-id="757b8-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="757b8-181">Hinzufügen von Geschäftslogik zum Durchführen eines Test Durchlaufs</span><span class="sxs-lookup"><span data-stu-id="757b8-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="757b8-182">Als nächstes implementieren Sie die Geschäftslogik, die es unmöglich macht, als Administrator einer Abteilung festzulegen, die bereits Administrator einer anderen Abteilung ist.</span><span class="sxs-lookup"><span data-stu-id="757b8-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="757b8-183">Sie lösen eine Ausnahme von der Geschäftslogik Schicht aus und fangen Sie dann in der Darstellungs Schicht ab, wenn ein Benutzer eine Abteilung bearbeitet und auf **Aktualisieren** klickt, nachdem jemand ausgewählt wurde, der bereits Administrator ist.</span><span class="sxs-lookup"><span data-stu-id="757b8-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="757b8-184">(Sie können Dozenten auch aus der Dropdown Liste entfernen, die bereits Administratoren sind, bevor Sie die Seite Renderern, aber der Zweck besteht darin, mit der Geschäftslogik Schicht zu arbeiten.)</span><span class="sxs-lookup"><span data-stu-id="757b8-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="757b8-185">Beginnen Sie mit dem Erstellen der Ausnahme Klasse, die Sie auslösen, wenn ein Benutzer versucht, einen Dozenten zu einem Administrator von mehreren Abteilungen zu machen.</span><span class="sxs-lookup"><span data-stu-id="757b8-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="757b8-186">Erstellen Sie im Hauptprojekt eine neue Klassendatei im Ordner *BLL* , nennen Sie Sie *DuplicateAdministratorException.cs*, und ersetzen Sie den vorhandenen Code durch den folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="757b8-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="757b8-187">Löschen Sie jetzt die temporäre Datei *DuplicateAdministratorException.cs* , die Sie zuvor im Testprojekt erstellt haben, damit Sie kompiliert werden kann.</span><span class="sxs-lookup"><span data-stu-id="757b8-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="757b8-188">Öffnen Sie im Hauptprojekt die Datei *SchoolBL.cs* , und fügen Sie die folgende Methode hinzu, die die Validierungs Logik enthält.</span><span class="sxs-lookup"><span data-stu-id="757b8-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="757b8-189">(Der Code verweist auf eine Methode, die Sie später erstellen.)</span><span class="sxs-lookup"><span data-stu-id="757b8-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="757b8-190">Diese Methode wird aufgerufen, wenn Sie `Department` Entitäten einfügen oder aktualisieren, um zu überprüfen, ob eine andere Abteilung bereits denselben Administrator hat.</span><span class="sxs-lookup"><span data-stu-id="757b8-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="757b8-191">Der Code Ruft eine Methode auf, um die Datenbank nach einer `Department` Entität zu durchsuchen, die denselben `Administrator`-Eigenschafts Wert aufweist wie die Entität, die eingefügt oder aktualisiert wird.</span><span class="sxs-lookup"><span data-stu-id="757b8-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="757b8-192">Wenn ein solcher gefunden wird, löst der Code eine Ausnahme aus.</span><span class="sxs-lookup"><span data-stu-id="757b8-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="757b8-193">Wenn die Entität, die eingefügt oder aktualisiert wird, keinen `Administrator` Wert hat, ist keine Überprüfungs Überprüfung erforderlich, und es wird keine Ausnahme ausgelöst, wenn die Methode während einer Aktualisierung aufgerufen wird und die gefundene `Department` Entität mit der `Department` Entität übereinstimmt, die aktualisiert wird</span><span class="sxs-lookup"><span data-stu-id="757b8-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="757b8-194">Nennen Sie die neue Methode aus den Methoden `Insert` und `Update`:</span><span class="sxs-lookup"><span data-stu-id="757b8-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="757b8-195">Fügen Sie in *ISchoolRepository.cs*die folgende Deklaration für die neue Datenzugriffs Methode hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="757b8-196">Fügen Sie in *SchoolRepository.cs*die folgende `using`-Anweisung hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="757b8-197">Fügen Sie in *SchoolRepository.cs*die folgende neue Datenzugriffs Methode hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="757b8-198">Dieser Code ruft `Department` Entitäten ab, die über einen angegebenen Administrator verfügen.</span><span class="sxs-lookup"><span data-stu-id="757b8-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="757b8-199">Es sollte nur eine Abteilung gefunden werden (sofern vorhanden).</span><span class="sxs-lookup"><span data-stu-id="757b8-199">Only one department should be found (if any).</span></span> <span data-ttu-id="757b8-200">Da jedoch keine Einschränkung in die Datenbank integriert ist, ist der Rückgabetyp eine Auflistung für den Fall, dass mehrere Abteilungen gefunden werden.</span><span class="sxs-lookup"><span data-stu-id="757b8-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="757b8-201">Wenn der Objekt Kontext Entitäten aus der Datenbank abruft, werden diese standardmäßig im Objekt Zustands-Manager nachverfolgt.</span><span class="sxs-lookup"><span data-stu-id="757b8-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="757b8-202">Der `MergeOption.NoTracking`-Parameter gibt an, dass diese Nachverfolgung für diese Abfrage nicht durchgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="757b8-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="757b8-203">Dies ist erforderlich, da die Abfrage möglicherweise die genaue Entität zurückgibt, die Sie aktualisieren möchten, und dann nicht mehr in der Lage sind, diese Entität anzufügen.</span><span class="sxs-lookup"><span data-stu-id="757b8-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="757b8-204">Wenn Sie z. b. die Verlaufs Abteilung auf der Seite " *Departments. aspx* " Bearbeiten und den Administrator unverändert lassen, wird die Verlaufs Abteilung von dieser Abfrage zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="757b8-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="757b8-205">Wenn `NoTracking` nicht festgelegt ist, verfügt der Objekt Kontext bereits über die Entität "Verlaufs Abteilung" in seinem Objekt Zustands-Manager.</span><span class="sxs-lookup"><span data-stu-id="757b8-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="757b8-206">Wenn Sie dann die Entität der Verlaufs Abteilung, die neu erstellt wird, aus dem Ansichts Zustand anfügen, löst der Objekt Kontext eine Ausnahme aus, die `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="757b8-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="757b8-207">(Als Alternative zum Angeben von `MergeOption.NoTracking`können Sie nur für diese Abfrage einen neuen Objekt Kontext erstellen.</span><span class="sxs-lookup"><span data-stu-id="757b8-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="757b8-208">Da der neue Objekt Kontext über einen eigenen Objekt Zustands-Manager verfügen würde, würde beim aufzurufen der `Attach`-Methode kein Konflikt auftreten.</span><span class="sxs-lookup"><span data-stu-id="757b8-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="757b8-209">Der neue Objekt Kontext würde Metadaten und die Datenbankverbindung mit dem ursprünglichen Objekt Kontext gemeinsam verwenden, sodass die Leistungseinbußen dieses alternativen Ansatzes minimal wäre.</span><span class="sxs-lookup"><span data-stu-id="757b8-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="757b8-210">Der hier gezeigte Ansatz führt jedoch die `NoTracking`-Option ein, die Sie in anderen Kontexten nützlich finden.</span><span class="sxs-lookup"><span data-stu-id="757b8-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="757b8-211">Die `NoTracking`-Option wird in einem späteren Tutorial dieser Reihe ausführlicher erläutert.)</span><span class="sxs-lookup"><span data-stu-id="757b8-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="757b8-212">Fügen Sie im Testprojekt die neue Datenzugriffs Methode zu *MockSchoolRepository.cs*hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="757b8-213">In diesem Code wird LINQ verwendet, um die gleiche Datenauswahl auszuführen, die das `ContosoUniversity` projektrepository LINQ to Entities für verwendet.</span><span class="sxs-lookup"><span data-stu-id="757b8-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="757b8-214">Führen Sie das Testprojekt erneut aus.</span><span class="sxs-lookup"><span data-stu-id="757b8-214">Run the test project again.</span></span> <span data-ttu-id="757b8-215">Dieses Mal werden die Tests bestanden.</span><span class="sxs-lookup"><span data-stu-id="757b8-215">This time the tests pass.</span></span>

<span data-ttu-id="757b8-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="757b8-217">Behandeln von ObjectDataSource-Ausnahmen</span><span class="sxs-lookup"><span data-stu-id="757b8-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="757b8-218">Führen Sie im `ContosoUniversity` Projekt die Seite " *Departments. aspx* " aus, und versuchen Sie, den Administrator für eine Abteilung zu einer Person zu wechseln, die bereits für eine andere Abteilung Administrator ist.</span><span class="sxs-lookup"><span data-stu-id="757b8-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="757b8-219">(Beachten Sie, dass Sie nur die Abteilungen bearbeiten können, die Sie in diesem Tutorial hinzugefügt haben, da die Datenbank mit ungültigen Daten vorab geladen wird.) Sie erhalten die folgende Server Fehlerseite:</span><span class="sxs-lookup"><span data-stu-id="757b8-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="757b8-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="757b8-221">Sie möchten nicht, dass Benutzer diese Art von Fehlerseite sehen, daher müssen Sie Fehler Behandlungs Code hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="757b8-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="757b8-222">Öffnen Sie " *Departments. aspx* ", und geben Sie einen Handler für das `OnUpdated`-Ereignis des `DepartmentsObjectDataSource`an.</span><span class="sxs-lookup"><span data-stu-id="757b8-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="757b8-223">Das `ObjectDataSource` öffnende Tag ähnelt nun dem folgenden Beispiel.</span><span class="sxs-lookup"><span data-stu-id="757b8-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="757b8-224">Fügen Sie in *Departments.aspx.cs*die folgende `using`-Anweisung hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="757b8-225">Fügen Sie den folgenden Handler für das `Updated`-Ereignis hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="757b8-226">Wenn das `ObjectDataSource` Steuerelement eine Ausnahme abfängt, wenn es versucht, das Update auszuführen, übergibt es die Ausnahme im Ereignis Argument (`e`) an diesen Handler.</span><span class="sxs-lookup"><span data-stu-id="757b8-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="757b8-227">Der Code im Handler prüft, ob es sich bei der Ausnahme um die doppelte Administrator Ausnahme handelt.</span><span class="sxs-lookup"><span data-stu-id="757b8-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="757b8-228">Wenn dies der Fall ist, erstellt der Code ein Validierungs Steuerelement, das eine Fehlermeldung enthält, die vom `ValidationSummary` Steuerelement angezeigt werden soll.</span><span class="sxs-lookup"><span data-stu-id="757b8-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="757b8-229">Führen Sie die Seite aus, und versuchen Sie, jemanden erneut als Administrator zweier Abteilungen zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="757b8-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="757b8-230">Dieses Mal zeigt das `ValidationSummary`-Steuerelement eine Fehlermeldung an.</span><span class="sxs-lookup"><span data-stu-id="757b8-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="757b8-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="757b8-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="757b8-232">Nehmen Sie ähnliche Änderungen an der Seite *departmentsadd. aspx* vor.</span><span class="sxs-lookup"><span data-stu-id="757b8-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="757b8-233">Geben *Sie in departmentsadd. aspx*einen Handler für das `OnInserted`-Ereignis des `DepartmentsObjectDataSource`an.</span><span class="sxs-lookup"><span data-stu-id="757b8-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="757b8-234">Das resultierende Markup ähnelt dem folgenden Beispiel.</span><span class="sxs-lookup"><span data-stu-id="757b8-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="757b8-235">Fügen Sie in *DepartmentsAdd.aspx.cs*dieselbe `using`-Anweisung hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="757b8-236">Fügen Sie den folgenden Ereignishandler hinzu:</span><span class="sxs-lookup"><span data-stu-id="757b8-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="757b8-237">Sie können nun die Seite " *DepartmentsAdd.aspx.cs* " testen, um sicherzustellen, dass die Versuche, eine Person als Administrator mehrerer Abteilungen einzurichten, auch ordnungsgemäß verarbeitet werden.</span><span class="sxs-lookup"><span data-stu-id="757b8-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="757b8-238">Dadurch wird die Einführung in die Implementierung des Repository-Musters für die Verwendung des `ObjectDataSource`-Steuer Elements mit dem Entity Framework vervollständigt.</span><span class="sxs-lookup"><span data-stu-id="757b8-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="757b8-239">Weitere Informationen über das Repository-Muster und die Testability finden Sie im MSDN-Whitepaper [Testability und Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="757b8-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="757b8-240">Im folgenden Tutorial erfahren Sie, wie Sie der Anwendung Sortier-und Filterfunktionen hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="757b8-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="757b8-241">[Zurück](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [Weiter](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="757b8-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
