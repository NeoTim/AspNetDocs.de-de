---
title: Schlüsselverwaltung in ASP.NET Core
author: rick-anderson
description: Erfahren Sie Details zur Implementierung der ASP.NET Core-Datenschutz Key Management-APIs.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 431bdf2d3076c83279b78f327ddb647f69e6e584
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 03/01/2019
ms.locfileid: "57042577"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="ff816-103">Schlüsselverwaltung in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="ff816-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="ff816-104">Das System zum Schutz von Daten verwaltet automatisch die Lebensdauer der Hauptschlüssel zum Schützen und Aufheben des Schutzes von Nutzlasten verwendet.</span><span class="sxs-lookup"><span data-stu-id="ff816-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="ff816-105">Jeder Schlüssel kann in einer von vier Phasen vorhanden sein:</span><span class="sxs-lookup"><span data-stu-id="ff816-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="ff816-106">Erstellt: der Schlüssel vorhanden ist, in dem Schlüsselbund jedoch noch nicht aktiviert wurde.</span><span class="sxs-lookup"><span data-stu-id="ff816-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="ff816-107">Für neue schützen Vorgänge der Schlüssel sollte nicht verwendet werden, bis genügend Zeit verstrichen ist, dass der Schlüssel Gelegenheit hatten wurde, auf alle Computer verteilt, die diese Schlüsselbund verbrauchen.</span><span class="sxs-lookup"><span data-stu-id="ff816-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="ff816-108">Aktiv - der Schlüssel vorhanden ist, in dem Schlüsselbund und sollte für alle neuen schützen Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ff816-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="ff816-109">Abgelaufen – der Schlüssel seiner natürlichen Lebensdauer ausgeführt wurde, und sollte nicht mehr für neue schützen Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ff816-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="ff816-110">Widerrufen: der Schlüssel gefährdet ist, und darf nicht für neue schützen Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ff816-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="ff816-111">Erstellte, aktive und abgelaufene Schlüssel möglicherweise alle zum Aufheben des Schutzes von eingehenden Nutzlasten verwendet.</span><span class="sxs-lookup"><span data-stu-id="ff816-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="ff816-112">Widerrufenen Schlüssel in der Standardeinstellung können nicht zum Aufheben des Schutzes von Nutzlasten verwendet werden, aber der Anwendungsentwickler kann [dieses Verhalten überschreiben](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) bei Bedarf.</span><span class="sxs-lookup"><span data-stu-id="ff816-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="ff816-113">Der Entwickler möglicherweise versucht, einen Schlüssel aus dem Schlüsselbund (z. B. durch das Löschen der entsprechenden Datei aus dem Dateisystem) zu löschen.</span><span class="sxs-lookup"><span data-stu-id="ff816-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="ff816-114">An diesem Punkt alle durch den Schlüssel geschützte Daten dauerhaft nicht lesbar ist, und es gibt keine Notfall außer Kraft setzen, wie bei der widerrufenen Schlüssel.</span><span class="sxs-lookup"><span data-stu-id="ff816-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="ff816-115">Löschen eines Schlüssels ist wirklich destruktive Verhalten, und daher macht System zum Schutz von Daten keine erstklassige API zum Ausführen des Vorgangs.</span><span class="sxs-lookup"><span data-stu-id="ff816-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="ff816-116">Wichtige Standardauswahl</span><span class="sxs-lookup"><span data-stu-id="ff816-116">Default key selection</span></span>

<span data-ttu-id="ff816-117">Wenn das System zum Schutz von Daten den Schlüsselbund aus dem Repository dahinter liegende liest, wird versucht, einen Schlüssel "Standard" aus dem Schlüsselbund gesucht werden soll.</span><span class="sxs-lookup"><span data-stu-id="ff816-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="ff816-118">Der Standardschlüssel wird für neue schützen Vorgänge verwendet.</span><span class="sxs-lookup"><span data-stu-id="ff816-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="ff816-119">Die allgemeine Heuristik ist, dass das System zum Schutz von Daten über die Taste mit dem letzten Aktivierungsdatum als Standardschlüssel auswählt.</span><span class="sxs-lookup"><span data-stu-id="ff816-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="ff816-120">(Es ist eine kleine Mogelfaktor, um Server-zu-Server Uhr datenschiefe zu ermöglichen.) Wenn der Schlüssel ist abgelaufen oder gesperrt, und wenn die Anwendung nicht automatisch deaktiviert hat schlüsselgenerierung, und klicken Sie dann ein neuer Schlüssel mit unmittelbaren Aktivierung pro generiert werden die [für den Ablauf und parallele](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) Richtlinie weiter unten.</span><span class="sxs-lookup"><span data-stu-id="ff816-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="ff816-121">Der Grund System zum Schutz von Daten generiert einen neuen Schlüssel sofort statt Fallback auf einen anderen Schlüssel besteht darin, dass die Generierung eines neuen Schlüssels als eine implizite Ablauf aller Schlüssel behandelt werden sollen, die vor dem neuen Schlüssel aktiviert wurden.</span><span class="sxs-lookup"><span data-stu-id="ff816-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="ff816-122">Der Grundgedanke ist, dass neue Schlüssel mit verschiedenen Algorithmen oder Verschlüsselung für ruhende-Mechanismen als alten Schlüssel konfiguriert wurden können, und das System vorziehen sollten, dass die aktuelle Konfiguration zurückgreifen.</span><span class="sxs-lookup"><span data-stu-id="ff816-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="ff816-123">Es ist eine Ausnahme aus.</span><span class="sxs-lookup"><span data-stu-id="ff816-123">There's an exception.</span></span> <span data-ttu-id="ff816-124">Wenn der Anwendungsentwickler kann [deaktiviert die automatische Generierung von Schlüsseln](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), und klicken Sie dann das System zum Schutz von Daten etwas als Standardschlüssel auswählen muss.</span><span class="sxs-lookup"><span data-stu-id="ff816-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="ff816-125">In diesem Szenario fallback wird das System den Schlüssel nicht widerrufen, mit dem das letzte Aktivierungsdatum, wählen Sie eingeräumt an Schlüsseln, die mit anderen Computern im Cluster verteilt werden mussten.</span><span class="sxs-lookup"><span data-stu-id="ff816-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="ff816-126">Das fallback-System kann am Ende einer abgelaufenen Standardschlüssel daher auswählen.</span><span class="sxs-lookup"><span data-stu-id="ff816-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="ff816-127">Das Fallbacksystem wählt nie einen widerrufenen Schlüssel als den Standardschlüssel, und wenn dem Schlüsselbund leer ist oder wurde jeder Schlüssel gesperrt klicken Sie dann das System tritt ein Fehler bei der Initialisierung.</span><span class="sxs-lookup"><span data-stu-id="ff816-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="ff816-128">Schlüsselablauf und parallele</span><span class="sxs-lookup"><span data-stu-id="ff816-128">Key expiration and rolling</span></span>

<span data-ttu-id="ff816-129">Wenn ein Schlüssel erstellt wird, erhält er automatisch ein Aktivierungs- und ein Ablaufdatum von {Now + 90 Tage} von {Now + 2 Tage}.</span><span class="sxs-lookup"><span data-stu-id="ff816-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="ff816-130">Die Verzögerung von 2 Tagen vor der Aktivierung erhalten die Schlüsselzeit über das System eine Weile dauern.</span><span class="sxs-lookup"><span data-stu-id="ff816-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="ff816-131">D. h. können sie andere Anwendungen, die auf den in den Sicherungsspeicher, beobachten Sie den Schlüssel an die nächste Aktualisierungsintervall, Maximieren daher die Wahrscheinlichkeit, dass wenn der Schlüssel des ringpufferziels werden wird aktiv, die Gruppe propagiert wurde für alle Anwendungen, die erforderlich sind verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ff816-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="ff816-132">Wenn der Standardschlüssel innerhalb von 2 Tagen ablaufen und den Schlüsselbund nicht bereits einen Schlüssel verfügen, der nach Ablauf des den Standardschlüssel aktiv sind, wird das System zum Schutz von Daten automatisch einen neuen Schlüssel, den Schlüsselbund beibehalten.</span><span class="sxs-lookup"><span data-stu-id="ff816-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="ff816-133">Dieses neuen Schlüssels verfügt über ein Aktivierungs- und Ablaufdatum {Now + 90 Tage} {Ablaufdatum der Standardschlüssel}.</span><span class="sxs-lookup"><span data-stu-id="ff816-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="ff816-134">Dadurch kann es sich um das System die Schlüssel automatisch in regelmäßigen Abständen ohne Unterbrechung des Diensts zurückzusetzen.</span><span class="sxs-lookup"><span data-stu-id="ff816-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="ff816-135">Es gibt möglicherweise Situationen, in dem ein Schlüssel mit der sofortigen Aktivierung erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="ff816-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="ff816-136">Ein Beispiel wäre, wenn die Anwendung noch nicht für einen Zeitraum ausgeführt, und alle Schlüssel in den Schlüsselbund abgelaufen sind.</span><span class="sxs-lookup"><span data-stu-id="ff816-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="ff816-137">In diesem Fall erhält der Schlüssel ein Datum der Aktivierung von {jetzt} ohne die normalen aktivierungsverzögerung von 2 Tagen.</span><span class="sxs-lookup"><span data-stu-id="ff816-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="ff816-138">Die Lebensdauer der Standard-Schlüssel ist 90 Tage lang auf, wenn dies konfiguriert ist, wie im folgenden Beispiel ist.</span><span class="sxs-lookup"><span data-stu-id="ff816-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="ff816-139">Ein Administrator kann auch standardmäßig eine systemweite, ändern, wenn ein expliziter Aufruf von `SetDefaultKeyLifetime` wird Richtlinie für eine systemweite außer Kraft gesetzt.</span><span class="sxs-lookup"><span data-stu-id="ff816-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="ff816-140">Die Lebensdauer der Standard-Schlüssel darf nicht weniger als 7 Tage sein.</span><span class="sxs-lookup"><span data-stu-id="ff816-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="ff816-141">Automatische Schlüsselbund aktualisieren</span><span class="sxs-lookup"><span data-stu-id="ff816-141">Automatic key ring refresh</span></span>

<span data-ttu-id="ff816-142">Wenn das System zum Schutz von Daten initialisiert wird, liest den Schlüsselbund aus dem zugrunde liegenden Repository und im Arbeitsspeicher zwischengespeichert.</span><span class="sxs-lookup"><span data-stu-id="ff816-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="ff816-143">Dieser Cache ermöglicht schützen und Unprotect-Vorgänge um den Vorgang fortzusetzen, ohne dass dafür auf den Sicherungsspeicher an.</span><span class="sxs-lookup"><span data-stu-id="ff816-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="ff816-144">Der Sicherungsspeicher für Änderungen wird von vom System automatisch geprüft werden, ungefähr 24 Stunden oder wenn der aktuelle Standardschlüssel abläuft, je nachdem, was zuerst eintritt.</span><span class="sxs-lookup"><span data-stu-id="ff816-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="ff816-145">Entwickler sollten nur sehr selten (wenn überhaupt) die Schlüssel-APIs direkt verwenden müssen.</span><span class="sxs-lookup"><span data-stu-id="ff816-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="ff816-146">Das System zum Schutz von Daten führt automatische schlüsselverwaltung, wie oben beschrieben.</span><span class="sxs-lookup"><span data-stu-id="ff816-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="ff816-147">Das System zum Schutz von Daten stellt eine Schnittstelle `IKeyManager` , die verwendet werden kann, um zu überprüfen, und nehmen Sie Änderungen an den Schlüsselbund.</span><span class="sxs-lookup"><span data-stu-id="ff816-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="ff816-148">Das DI-System, das die Instanz angegebenen `IDataProtectionProvider` bieten auch eine Instanz von `IKeyManager` für den Verbrauch.</span><span class="sxs-lookup"><span data-stu-id="ff816-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="ff816-149">Alternativ können Sie abrufen, die `IKeyManager` direkt aus der `IServiceProvider` wie im folgenden Beispiel.</span><span class="sxs-lookup"><span data-stu-id="ff816-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="ff816-150">Jeder Vorgang, der bestimmt, den Schlüsselbund (einen neuen Schlüssel explizit erstellen oder Ausführen einer Sperrung) wird in-Memory-Cache ungültig.</span><span class="sxs-lookup"><span data-stu-id="ff816-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="ff816-151">Beim nächsten Aufruf von `Protect` oder `Unprotect` bewirkt, dass das System zum Schutz von Daten gebundenes den Schlüsselbund und neu erstellen, den Cache.</span><span class="sxs-lookup"><span data-stu-id="ff816-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="ff816-152">Das folgende Beispiel veranschaulicht die Verwendung der `IKeyManager` Schnittstelle, um zu überprüfen und ändern den Schlüsselbund, einschließlich entziehen vorhandenen Schlüssel und einen neuen Schlüssel manuell zu generieren.</span><span class="sxs-lookup"><span data-stu-id="ff816-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="ff816-153">Speichern von Schlüsseln</span><span class="sxs-lookup"><span data-stu-id="ff816-153">Key storage</span></span>

<span data-ttu-id="ff816-154">Das System zum Schutz von Daten verfügt über eine Heuristik, bei dem versucht wird, einen entsprechenden Schlüssel Speicherort und die Verschlüsselung im Ruhezustand Methode automatisch hergeleitet werden.</span><span class="sxs-lookup"><span data-stu-id="ff816-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="ff816-155">Der schlüsselpersistenz-Mechanismus kann auch vom app-Entwickler konfiguriert werden.</span><span class="sxs-lookup"><span data-stu-id="ff816-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="ff816-156">In den folgenden Dokumenten erläutert die integrierten Implementierungen dieser Mechanismen:</span><span class="sxs-lookup"><span data-stu-id="ff816-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
